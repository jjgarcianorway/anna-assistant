# v6.24.0-alpha: Insights Engine Foundation

**Release Date:** 2025-11-24
**Status:** Alpha - Foundation Complete, Full Release Pending
**Theme:** Historical Metrics & Insight Engine Infrastructure

## Overview

v6.24.0-alpha establishes the foundation for Anna's Insights Engine - a rules-based system that analyzes historical metrics to provide actionable insights about system health trends. This alpha release focuses on the core architecture and detection algorithms, with full status integration and comprehensive testing planned for the final 6.24.0 release.

## ‚úÖ Completed in Alpha

### Core Infrastructure

**Insights Engine (`insights_engine.rs`)**
- `InsightsEngine` struct with Historian integration
- `Insight` struct with severity, evidence, and suggestions
- `InsightSeverity` enum: Info, Warning, Critical
- Builder pattern for flexible insight construction
- Automatic severity-based sorting

**Insight Detectors (6 total)**
1. **Boot Regression Detection** - Identifies increasing boot times
2. **Disk Space Monitoring** - Tracks usage with growth rate predictions
3. **Error Rate Spike Detection** - Monitors journal error frequency
4. **Memory Pressure Tracking** - Detects sustained memory growth
5. **Anna Inactivity Detection** - Warns when Anna hasn't been used
6. **Swap Usage Anomalies** - Stubbed (awaiting Historian enhancement)

### Historian Enhancements

**New Methods:**
```rust
pub fn get_disk_trends(&self, days: u32) -> Result<DiskTrends>
pub fn get_anna_usage_stats(&self, hours: i64) -> Result<AnnaUsageStats>
pub fn get_error_trends_v2(&self, hours: i64) -> Result<ErrorTrendsV2>
```

**New Data Structures:**
```rust
pub struct DiskTrends {
    pub used_gb: f64,
    pub total_gb: f64,
    pub current_used_percent: f64,
    pub growth_rate_gb_per_day: f64,
    pub days_analyzed: u32,
}

pub struct AnnaUsageStats {
    pub invocation_count: i32,
    pub hours_since_last_invocation: i64,
    pub hours_analyzed: i64,
}

pub struct ErrorTrendsV2 {
    pub total_errors: usize,
    pub total_warnings: usize,
    pub total_criticals: usize,
    pub avg_errors_per_hour: f64,
    pub hours_analyzed: i64,
}
```

### Dependencies Added
- `chrono::Duration` for time calculations
- `rusqlite::params` macro for SQL queries

## üìä Example Insights

### Boot Regression
```
Severity: Warning
Title: Boot Time Increasing
Explanation: System boot time has been increasing over the last 30 days.
             Average boot time is now 18500 ms (18 seconds).
Evidence:
  - Average boot time: 18500 ms
  - Trend: Increasing over 30 days
Suggestion: Review recently enabled systemd services with 'systemd-analyze blame'
```

### Disk Space Critical
```
Severity: Critical
Title: Disk Space Critical
Explanation: Root filesystem is 92% full (450.5 GB used of 490.0 GB total).
             At current growth rate, disk will be full in 8 days.
Evidence:
  - Current usage: 92.0%
  - Growth rate: 5.12 GB/day
Suggestion: Run 'annactl "clean up disk space"' for cleanup recommendations
```

### Error Spike
```
Severity: Critical
Title: High Error Rate Detected
Explanation: System is generating 150 errors per hour on average over the
             last 24 hours. This indicates a serious problem.
Evidence:
  - Average: 150 errors/hour
  - Total: 3600 errors
Suggestion: Run 'annactl "check my system health"' for diagnostic details
```

## üîß Architecture

### Insight Generation Flow
```
User/Status Request
    ‚Üì
InsightsEngine::generate_insights()
    ‚Üì
‚îú‚îÄ> detect_boot_regression()     ‚Üí TrendDetectors
‚îú‚îÄ> detect_disk_space_issues()   ‚Üí Historian::get_disk_trends()
‚îú‚îÄ> detect_error_spikes()        ‚Üí Historian::get_error_trends_v2()
‚îú‚îÄ> detect_memory_pressure()     ‚Üí TrendDetectors
‚îú‚îÄ> detect_swap_anomalies()      ‚Üí [Stubbed]
‚îî‚îÄ> detect_anna_inactivity()     ‚Üí Historian::get_anna_usage_stats()
    ‚Üì
Sort by severity (Critical > Warning > Info)
    ‚Üì
Return Vec<Insight>
```

### Design Principles

**Rules-Based, Not LLM-Dependent**
- All detection logic is deterministic
- No LLM calls required for insight generation
- Fast, predictable performance

**Evidence-Backed**
- Every insight includes supporting data
- Transparent reasoning for recommendations
- User can verify the diagnosis

**Actionable**
- Optional suggestions with specific commands
- Links to relevant Anna capabilities
- Clear next steps for user

## üöß Known Limitations (Alpha)

### Not Yet Implemented
1. **Status Integration** - Insights don't yet appear in `annactl status`
2. **Daily Metrics Capture** - Anna usage tracking not wired to daemon
3. **Swap Detection** - Requires MemoryTrends struct extension
4. **Schema Migrations** - No version tracking or auto-migration yet
5. **Comprehensive Tests** - Only 3 basic unit tests included

### Temporary Stubs
- `detect_swap_anomalies()` returns `Ok(None)` - implementation pending MemoryTrends enhancement
- Anna usage stats estimation is placeholder - needs dedicated tracking table

## ‚úÖ Quality Assurance

### Build Status
- ‚úÖ Full release build succeeds
- ‚úÖ All crates compile without errors
- ‚úÖ Zero compilation errors
- ‚úÖ Only benign warnings (unused imports, dead code)

### Test Coverage
```rust
#[test]
fn test_insight_severity_ordering() { ... }  // ‚úì Passes
fn test_insight_id_generation() { ... }      // ‚úì Passes
fn test_insight_builder_pattern() { ... }    // ‚úì Passes
```

### No Regressions
- Existing functionality unaffected
- All imports properly scoped
- No breaking changes to public APIs

## üì¶ Files Changed

**New Files:**
- `crates/anna_common/src/insights_engine.rs` (430 lines)

**Modified Files:**
- `Cargo.toml` - Version bump to 6.24.0-alpha
- `crates/anna_common/src/historian.rs` - Added 3 methods, 3 structs
- `crates/anna_common/src/lib.rs` - Exported insights_engine module
- `README.md` - Updated version badges

**Total Addition:** ~560 lines of new code

## üéØ Roadmap to v6.24.0 Final

### Status Integration
- [ ] Add `get_top_insights()` call to status command
- [ ] Format insights for CLI display (before other sections)
- [ ] Test insights display with various system states

### Metrics Capture
- [ ] Wire Anna usage tracking into daemon
- [ ] Add invocation timestamp logging
- [ ] Create session-level intent tracking table

### Swap Detection
- [ ] Extend MemoryTrends with swap fields
- [ ] Implement full `detect_swap_anomalies()` logic
- [ ] Add tests for swap warnings

### Schema Management
- [ ] Implement schema version tracking
- [ ] Create migration system for DB updates
- [ ] Handle version mismatches gracefully

### Comprehensive Testing
- [ ] Unit tests for all 6 detectors
- [ ] Integration tests with mock Historian
- [ ] End-to-end tests via ACTS framework
- [ ] Regression test suite

### Documentation
- [ ] User-facing documentation for insights
- [ ] Developer guide for adding new detectors
- [ ] Update CHANGELOG.md

## üìù Developer Notes

### Adding New Detectors

To add a new insight detector:

1. **Create detector method:**
```rust
fn detect_new_issue(&self) -> Result<Option<Insight>> {
    let data = self.historian.get_relevant_trends()?;

    if condition_met {
        Ok(Some(
            Insight::new("detector_id", InsightSeverity::Warning, "Title", "Explanation")
                .with_evidence(vec![...])
                .with_suggestion("Do this")
        ))
    } else {
        Ok(None)
    }
}
```

2. **Wire into `generate_insights()`:**
```rust
if let Some(insight) = self.detect_new_issue()? {
    insights.push(insight);
}
```

3. **Add tests:**
```rust
#[test]
fn test_new_issue_detection() { ... }
```

### Severity Guidelines

**Critical:** Immediate action required, system at risk
- Disk >90% full with <7 days to full
- >100 errors/hour sustained
- Heavy swap usage (>50%)

**Warning:** Attention needed soon, trend concerning
- Disk >80% full or rapid growth
- >20 errors/hour
- Memory pressure increasing

**Info:** Informational, no immediate action
- Anna unused for 7+ days
- Performance observations

## üéì Testing Instructions

### Manual Testing (Alpha)

Since status integration isn't complete, test via Rust REPL:

```rust
use anna_common::historian::Historian;
use anna_common::insights_engine::InsightsEngine;

let historian = Historian::open("/var/lib/anna/historian.db")?;
let engine = InsightsEngine::new(historian);

let insights = engine.generate_insights(24)?;
for insight in insights {
    println!("{:?}", insight);
}
```

### Unit Tests

```bash
cargo test -p anna_common insights_engine
```

## üîÆ Vision: Full v6.24.0

The complete v6.24.0 will deliver:

1. **Proactive Health Monitoring** - Anna tells you about problems before you notice them
2. **Trend-Based Diagnostics** - "Boot time was 8s a month ago, now 18s"
3. **Data-Driven Insights** - No guessing, evidence-backed recommendations
4. **Zero-Configuration** - Works automatically with existing Historian data
5. **Status-First UX** - Insights front-and-center in `annactl status`

**Use Case Example:**
```
$ annactl status

[INSIGHTS]
üî¥ Critical: Disk Space Critical
   Root filesystem is 92% full. Will be full in 8 days at current rate.
   ‚Üí Run 'annactl "clean up disk space"'

‚ö†Ô∏è  Warning: Boot Time Increasing
   Average boot time now 18s, up from 8s a month ago.
   ‚Üí Review systemd services with 'systemd-analyze blame'

[ANNA HEALTH]
‚úì Daemon: Running (annad v6.24.0)
‚úì LLM: Ollama (llama3.2:3b)
...
```

## üôè Acknowledgments

This alpha release establishes the foundation for a significant capability upgrade. The Insights Engine transforms Anna from reactive ("check this") to proactive ("you should know about this").

---

**Next:** Complete v6.24.0 with status integration, comprehensive tests, and full documentation in next session.
