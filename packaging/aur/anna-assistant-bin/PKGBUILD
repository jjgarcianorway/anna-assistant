# Maintainer: Juan Jose Garcia <jjgarcianorway@gmail.com>
pkgname=anna-assistant-bin
pkgver=1.16.3_alpha.1
pkgrel=1
pkgdesc="Arch Linux AI assistant with ethical AI, consensus, and self-healing capabilities"
arch=('x86_64')
url="https://github.com/jjgarcianorway/anna-assistant"
license=('custom')
depends=('systemd')
optdepends=(
    'prometheus: metrics collection'
    'grafana: monitoring dashboards'
)
provides=('anna-assistant')
conflicts=('anna-assistant')
backup=(
    'etc/anna/config.toml'
    'etc/anna/pinning.toml'
)
source=(
    "annad-${pkgver}-x86_64::https://github.com/jjgarcianorway/anna-assistant/releases/download/v${pkgver/_/-}/annad-${pkgver/_/-}-x86_64-unknown-linux-gnu"
    "annactl-${pkgver}-x86_64::https://github.com/jjgarcianorway/anna-assistant/releases/download/v${pkgver/_/-}/annactl-${pkgver/_/-}-x86_64-unknown-linux-gnu"
    "SHA256SUMS::https://github.com/jjgarcianorway/anna-assistant/releases/download/v${pkgver/_/-}/SHA256SUMS"
    "annad.service"
    "config.toml"
)
sha256sums=('SKIP'  # annad binary
            'SKIP'  # annactl binary
            'SKIP'  # SHA256SUMS
            'SKIP'  # annad.service
            'SKIP') # config.toml

# Note: Update sha256sums after first build with: makepkg -g

prepare() {
    cd "${srcdir}"

    # Verify checksums from official release
    echo "Verifying binary checksums..."
    grep "annad-${pkgver/_/-}-x86_64-unknown-linux-gnu" SHA256SUMS | sha256sum -c - || {
        echo "ERROR: annad checksum verification failed!"
        return 1
    }
    grep "annactl-${pkgver/_/-}-x86_64-unknown-linux-gnu" SHA256SUMS | sha256sum -c - || {
        echo "ERROR: annactl checksum verification failed!"
        return 1
    }

    # Make binaries executable
    chmod +x "annad-${pkgver}-x86_64"
    chmod +x "annactl-${pkgver}-x86_64"
}

package() {
    # Install binaries
    install -Dm755 "${srcdir}/annad-${pkgver}-x86_64" "${pkgdir}/usr/bin/annad"
    install -Dm755 "${srcdir}/annactl-${pkgver}-x86_64" "${pkgdir}/usr/bin/annactl"

    # Install systemd service
    install -Dm644 "${srcdir}/annad.service" "${pkgdir}/usr/lib/systemd/system/annad.service"

    # Install default config
    install -Dm644 "${srcdir}/config.toml" "${pkgdir}/etc/anna/config.toml"

    # Create necessary directories
    install -dm750 "${pkgdir}/var/lib/anna"
    install -dm750 "${pkgdir}/var/lib/anna/keys"
    install -dm750 "${pkgdir}/var/lib/anna/chronos"
    install -dm750 "${pkgdir}/var/lib/anna/collective"
    install -dm750 "${pkgdir}/var/lib/anna/reports"
    install -dm750 "${pkgdir}/etc/anna"

    # Install docs
    install -dm755 "${pkgdir}/usr/share/doc/${pkgname}"

    # Note: Actual docs should be downloaded from repo or included in release
    echo "Documentation: ${url}" > "${pkgdir}/usr/share/doc/${pkgname}/README"
}

post_install() {
    echo "==> Creating 'anna' group..."
    getent group anna >/dev/null || groupadd -r anna

    echo "==> Setting permissions..."
    chown -R root:anna /var/lib/anna
    chmod -R 750 /var/lib/anna
    chown root:anna /etc/anna/config.toml
    chmod 640 /etc/anna/config.toml

    echo "==> Adding your user to 'anna' group..."
    echo "    Run: sudo usermod -aG anna \$USER && newgrp anna"

    echo "==> To start anna-assistant:"
    echo "    sudo systemctl enable --now annad"
    echo "    annactl status"

    echo "==> For troubleshooting:"
    echo "    sudo journalctl -u annad -f"
}

post_upgrade() {
    post_install
}

pre_remove() {
    systemctl stop annad.service 2>/dev/null || true
    systemctl disable annad.service 2>/dev/null || true
}

post_remove() {
    echo "==> Anna Assistant has been removed."
    echo "==> To clean up data: sudo rm -rf /var/lib/anna"
    echo "==> To remove group: sudo groupdel anna"
}
