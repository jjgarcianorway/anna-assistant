name: Release Discipline

on:
  pull_request:
    branches: [main]

jobs:
  check-version-changes:
    name: Version Change Discipline
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if VERSION changed
        id: version-changed
        run: |
          if git diff --name-only origin/main...HEAD | grep -q "^VERSION$"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "VERSION file changed in this PR"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "VERSION file not changed"
          fi

      - name: Require CHANGELOG update with VERSION change
        if: steps.version-changed.outputs.changed == 'true'
        run: |
          if ! git diff --name-only origin/main...HEAD | grep -q "^CHANGELOG.md$"; then
            echo "ERROR: VERSION changed but CHANGELOG.md was not updated"
            echo "When bumping version, you must add a CHANGELOG entry"
            exit 1
          fi
          echo "OK: CHANGELOG.md updated with VERSION change"

      - name: Check CHANGELOG has entry for new version
        if: steps.version-changed.outputs.changed == 'true'
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          if ! grep -q "## \[$VERSION\]" CHANGELOG.md; then
            echo "ERROR: CHANGELOG.md missing entry for version $VERSION"
            exit 1
          fi
          echo "OK: CHANGELOG has entry for $VERSION"

  check-update-logic-changes:
    name: Update Logic Discipline
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if update logic changed
        id: update-changed
        run: |
          # Files that contain update logic
          update_files=(
            "crates/annad/src/server.rs"
          )

          changed=false
          for file in "${update_files[@]}"; do
            if git diff --name-only origin/main...HEAD | grep -q "^$file$"; then
              echo "Update-related file changed: $file"
              changed=true
            fi
          done

          echo "changed=$changed" >> $GITHUB_OUTPUT

      - name: Require UPDATE_PROTOCOL.md update
        if: steps.update-changed.outputs.changed == 'true'
        run: |
          if ! git diff --name-only origin/main...HEAD | grep -q "^docs/UPDATE_PROTOCOL.md$"; then
            echo "WARNING: Update logic changed but docs/UPDATE_PROTOCOL.md was not updated"
            echo "Consider updating the documentation if the update behavior changed"
          else
            echo "OK: UPDATE_PROTOCOL.md updated with update logic changes"
          fi
