name: Daemon Health Check

on:
  push:
    branches: [ main, anna-1.0-reset ]
  pull_request:
    branches: [ main, anna-1.0-reset ]

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  ANNA_VERSION: test-build

jobs:
  daemon-security-validation:
    name: Daemon security and health validation
    runs-on: ubuntu-latest
    container: archlinux:latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm base-devel rust libcap git

    - name: Build binaries
      run: cargo build --release --verbose

    - name: Install binaries
      run: |
        cp target/release/annad /usr/local/bin/annad
        cp target/release/annactl /usr/local/bin/annactl
        chmod 755 /usr/local/bin/annad /usr/local/bin/annactl

    - name: Phase 0.4 - Create anna system group
      run: |
        groupadd --system anna || true
        getent group anna
        echo "✓ anna group created"

    - name: Phase 0.4 - Create secure directories
      run: |
        # /etc/anna - Configuration (root:root 0700)
        mkdir -p /etc/anna
        chown root:root /etc/anna
        chmod 700 /etc/anna

        # /var/log/anna - Logs (root:root 0700)
        mkdir -p /var/log/anna
        chown root:root /var/log/anna
        chmod 700 /var/log/anna

        # /var/lib/anna - State (root:root 0700)
        mkdir -p /var/lib/anna/reports /var/lib/anna/alerts
        chown -R root:root /var/lib/anna
        chmod 700 /var/lib/anna /var/lib/anna/reports /var/lib/anna/alerts

        # /usr/local/lib/anna - Static assets (root:root 0755)
        mkdir -p /usr/local/lib/anna
        chown root:root /usr/local/lib/anna
        chmod 755 /usr/local/lib/anna

        # /run/anna - Runtime directory (rc.13.2: manually create for CI)
        # RuntimeDirectory in systemd doesn't work reliably in GitHub Actions
        mkdir -p /run/anna
        chown root:anna /run/anna
        chmod 750 /run/anna

        echo "✓ Secure directories created (including /run/anna for CI)"

    - name: Phase 0.4 - Start daemon (direct, no systemd in container)
      run: |
        # Start daemon in background
        /usr/local/bin/annad &
        DAEMON_PID=$!
        echo "Started daemon with PID: $DAEMON_PID"
        echo $DAEMON_PID > /tmp/annad.pid

        # Wait up to 10 seconds for daemon to be ready
        for i in {1..10}; do
          if [ -S /run/anna/anna.sock ]; then
            echo "✓ Daemon socket created after ${i}s"
            break
          fi
          if [ $i -eq 10 ]; then
            echo "✗ Daemon socket not created within 10 seconds"
            echo "Daemon may have crashed. Checking if process is still running..."
            if kill -0 $DAEMON_PID 2>/dev/null; then
              echo "Daemon process is still running"
            else
              echo "Daemon process has exited"
            fi
            exit 1
          fi
          sleep 1
        done

        echo "✓ Daemon started successfully"

    - name: Phase 0.4 - Validate socket permissions
      run: |
        # Socket should already exist from previous step
        if [ ! -S /run/anna/anna.sock ]; then
          echo "✗ Socket does not exist"
          ls -la /run/anna/ || echo "/run/anna does not exist"
          exit 1
        fi

        # Check socket permissions
        SOCKET_PERMS=$(stat -c "%a" /run/anna/anna.sock)
        SOCKET_OWNER=$(stat -c "%U:%G" /run/anna/anna.sock)

        echo "Socket permissions: $SOCKET_PERMS"
        echo "Socket owner: $SOCKET_OWNER"

        # Verify permissions are 660
        if [ "$SOCKET_PERMS" != "660" ]; then
          echo "✗ Socket permissions should be 660, got $SOCKET_PERMS"
          exit 1
        fi

        # Verify owner is root:anna
        if [ "$SOCKET_OWNER" != "root:anna" ]; then
          echo "✗ Socket owner should be root:anna, got $SOCKET_OWNER"
          exit 1
        fi

        echo "✓ Socket permissions validated (root:anna 660)"

    - name: Phase 0.4 - Verify annactl status response time (<100ms)
      run: |
        # Test response time
        START_TIME=$(date +%s%N)
        annactl status >/dev/null 2>&1 || true
        END_TIME=$(date +%s%N)

        DURATION_MS=$(( (END_TIME - START_TIME) / 1000000 ))

        echo "Response time: ${DURATION_MS}ms"

        if [ $DURATION_MS -gt 100 ]; then
          echo "⚠ Response time ${DURATION_MS}ms exceeds 100ms target (may be acceptable in CI)"
        else
          echo "✓ Response time ${DURATION_MS}ms < 100ms"
        fi

    - name: Phase 0.4 - Verify annactl returns valid state
      run: |
        # Run annactl status and check for valid state
        OUTPUT=$(annactl status 2>&1 || true)
        echo "$OUTPUT"

        # Should contain state information
        if echo "$OUTPUT" | grep -q "state:"; then
          echo "✓ annactl status returns valid state"
        else
          echo "✗ annactl status did not return state information"
          exit 1
        fi

    - name: Phase 0.4 - Validate daemon process
      run: |
        # Get PID of annad process
        ANNAD_PID=$(pgrep -x annad || echo "")

        if [ -z "$ANNAD_PID" ]; then
          echo "✗ annad process not found"
          exit 1
        fi

        echo "✓ annad process running with PID: $ANNAD_PID"

        # Check process status (basic validation in container)
        if ps -p $ANNAD_PID > /dev/null; then
          echo "✓ Daemon process is healthy"
        else
          echo "✗ Daemon process check failed"
          exit 1
        fi

    - name: Cleanup
      if: always()
      run: |
        # Kill daemon if running
        pkill -x annad || true
        rm -f /run/anna/anna.sock /tmp/annad.pid
