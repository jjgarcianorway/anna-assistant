name: Consensus Smoke Test

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Security Check - No committed TLS materials
      run: |
        echo "Checking for committed TLS materials..."
        FOUND=$(git ls-files | grep -E '\.(key|pem|srl|crt|csr)$' || true)
        if [ -n "$FOUND" ]; then
          echo "ERROR: Found committed TLS materials:"
          echo "$FOUND"
          echo ""
          echo "Private keys and certificates must never be committed to git."
          echo "See testnet/config/README.md for certificate generation."
          exit 1
        fi
        echo "✓ No TLS materials in git"

    - name: Generate ephemeral TLS certificates
      run: |
        echo "Generating test certificates..."
        chmod +x ./scripts/gen-selfsigned-ca.sh
        ./scripts/gen-selfsigned-ca.sh
        echo "✓ Certificates generated"

    - name: Install Rust stable
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        override: true

    - name: Build binaries
      run: cargo build --release --bins

    - name: Run unit tests
      run: cargo test --lib --workspace

    - name: Run integration tests
      run: |
        cargo test --package annad --test '*' -- --nocapture || true
        cargo test --package annactl --test '*' -- --nocapture || true

    - name: Check binary versions
      run: |
        ./target/release/annad --version
        ./target/release/annactl --version

    - name: Verify version matches tag (if tagged)
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        TAG_VERSION="$GITHUB_REF"
        TAG_VERSION="${TAG_VERSION#refs/tags/v}"
        BINARY_VERSION=$(./target/release/annactl --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+(-[a-z0-9\.]+)?')
        echo "Tag version: $TAG_VERSION"
        echo "Binary version: $BINARY_VERSION"
        if [ "$TAG_VERSION" != "$BINARY_VERSION" ]; then
          echo "ERROR: Version mismatch!"
          exit 1
        fi
        echo "Versions match"
