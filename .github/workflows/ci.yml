# Anna Assistant CI - Arch Linux Only
# v0.0.32: CI Hardening + "No Regressions" Gate
#
# This workflow runs on every PR and push to main.
# All jobs run in an Arch Linux container - the only supported platform.
#
# Rules:
# - No green, no merge
# - No regressions allowed
# - All tests must pass on Arch Linux

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ==========================================================================
  # Build Matrix (Arch Linux only)
  # ==========================================================================
  build:
    name: Build (${{ matrix.profile }})
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    strategy:
      matrix:
        profile: [debug, release]
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git base-devel rustup
          rustup default stable

      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-arch-cargo-${{ matrix.profile }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-arch-cargo-${{ matrix.profile }}-

      - name: Build (${{ matrix.profile }})
        run: |
          if [ "${{ matrix.profile }}" = "release" ]; then
            cargo build --release --workspace
          else
            cargo build --workspace
          fi

      - name: Upload artifacts (release only)
        if: matrix.profile == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: binaries-arch
          path: |
            target/release/annad
            target/release/annactl

  # ==========================================================================
  # Unit Tests
  # ==========================================================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    needs: build
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git base-devel rustup
          rustup default stable

      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-arch-cargo-test-${{ hashFiles('**/Cargo.lock') }}

      - name: Run unit tests
        run: cargo test --workspace --lib

      - name: Run integration tests
        run: cargo test --workspace --test '*'

  # ==========================================================================
  # Clippy Lints
  # ==========================================================================
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git base-devel rustup
          rustup default stable
          rustup component add clippy

      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-arch-cargo-clippy-${{ hashFiles('**/Cargo.lock') }}

      - name: Run clippy
        run: cargo clippy --workspace --all-targets -- -D warnings
        continue-on-error: true  # Warn but don't fail for now (many existing warnings)

  # ==========================================================================
  # Rustfmt Check
  # ==========================================================================
  fmt:
    name: Format
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git base-devel rustup
          rustup default stable
          rustup component add rustfmt

      - name: Checkout
        uses: actions/checkout@v4

      - name: Check formatting
        run: cargo fmt --all -- --check
        continue-on-error: true  # Warn but don't fail for now

  # ==========================================================================
  # Security Audit
  # ==========================================================================
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git base-devel rustup
          rustup default stable

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked || echo "cargo-audit install failed, continuing"

      - name: Run cargo audit
        run: |
          if command -v cargo-audit &> /dev/null; then
            cargo audit || echo "Audit found issues (advisory)"
          else
            echo "cargo-audit not available, skipping"
          fi
        continue-on-error: true  # Advisory only

  # ==========================================================================
  # Integration Smoke Tests
  # ==========================================================================
  smoke:
    name: Smoke Tests
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    needs: build
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git base-devel rustup time procps-ng
          rustup default stable

      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-arch-cargo-smoke-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release
        run: cargo build --release --workspace

      - name: Test --version
        run: |
          ./target/release/annactl --version
          VERSION=$(./target/release/annactl --version | grep -oP 'v\d+\.\d+\.\d+' || echo "unknown")
          echo "Detected version: $VERSION"
          if [ "$VERSION" = "unknown" ]; then
            echo "ERROR: Could not detect version"
            exit 1
          fi

      - name: Test --help (strict surface)
        run: |
          ./target/release/annactl --help
          # Verify strict CLI surface - no legacy commands
          if ./target/release/annactl --help | grep -qE 'annactl\s+(sw|hw)\s' ; then
            echo "ERROR: Legacy commands found in help output"
            exit 1
          fi
          echo "OK: No legacy commands in help"

      - name: Test status (no daemon)
        run: |
          # Status should handle missing daemon gracefully (exit 0 or show error)
          ./target/release/annactl status 2>&1 || true
          echo "OK: status handled gracefully"

      - name: Test natural language (fallback mode)
        run: |
          # Should produce output even without Ollama
          OUTPUT=$(./target/release/annactl "what CPU do I have?" 2>&1 || true)
          echo "$OUTPUT"
          # Must contain reliability line (even with fallback)
          if ! echo "$OUTPUT" | grep -qi "reliability"; then
            echo "ERROR: No reliability score in output"
            exit 1
          fi
          echo "OK: Reliability score present"

      - name: Test debug transcript format
        run: |
          OUTPUT=$(./target/release/annactl "test query" 2>&1 || true)
          echo "$OUTPUT"
          # Must show dialogue format
          if ! echo "$OUTPUT" | grep -qE '\[you\]|\[anna\]|\[translator\]'; then
            echo "WARNING: No dialogue markers in output (may be debug level 0)"
          fi

  # ==========================================================================
  # Repo Hygiene Checks
  # ==========================================================================
  hygiene:
    name: Repo Hygiene
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for legacy commands in docs
        run: |
          # Fail if docs mention legacy CLI commands as valid
          # Allow mentions in "removed" or historical context
          if grep -rE 'annactl\s+(sw|hw)\s+#|^\s+annactl\s+(sw|hw)\s*$' README.md CLAUDE.md 2>/dev/null; then
            echo "ERROR: Legacy commands found as valid in documentation"
            exit 1
          fi
          echo "OK: No legacy commands presented as valid in docs"

      - name: Check version consistency
        run: |
          CARGO_VERSION=$(grep -m1 '^version = ' Cargo.toml | cut -d'"' -f2)
          CLAUDE_VERSION=$(grep -oP 'Version: \K[\d.]+' CLAUDE.md || echo "not found")
          README_VERSION=$(grep -oP 'Anna Assistant v\K[\d.]+' README.md || echo "not found")

          echo "Cargo.toml: $CARGO_VERSION"
          echo "CLAUDE.md: $CLAUDE_VERSION"
          echo "README.md: $README_VERSION"

          if [ "$CARGO_VERSION" != "$CLAUDE_VERSION" ]; then
            echo "ERROR: Version mismatch between Cargo.toml and CLAUDE.md"
            exit 1
          fi
          if [ "$CARGO_VERSION" != "$README_VERSION" ]; then
            echo "ERROR: Version mismatch between Cargo.toml and README.md"
            exit 1
          fi
          echo "OK: Versions consistent"

      - name: Check TODO.md version
        run: |
          CARGO_VERSION=$(grep -m1 '^version = ' Cargo.toml | cut -d'"' -f2)
          TODO_VERSION=$(grep -oP 'Current Version: \K[\d.]+' TODO.md || echo "not found")

          echo "Cargo.toml: $CARGO_VERSION"
          echo "TODO.md: $TODO_VERSION"

          if [ "$CARGO_VERSION" != "$TODO_VERSION" ]; then
            echo "ERROR: TODO.md version not updated"
            exit 1
          fi
          echo "OK: TODO.md version matches"

      - name: Check RELEASE_NOTES has current version
        run: |
          CARGO_VERSION=$(grep -m1 '^version = ' Cargo.toml | cut -d'"' -f2)
          if ! grep -q "## v$CARGO_VERSION" RELEASE_NOTES.md; then
            echo "ERROR: RELEASE_NOTES.md missing entry for v$CARGO_VERSION"
            exit 1
          fi
          echo "OK: RELEASE_NOTES.md has entry for v$CARGO_VERSION"

      - name: Check for root-level cruft
        run: |
          # Allowlist of expected root files/dirs
          ALLOWLIST="Cargo.toml Cargo.lock README.md CLAUDE.md TODO.md RELEASE_NOTES.md LICENSE .gitignore .github rustfmt.toml crates scripts"

          WARNINGS=0
          for f in * .[!.]*; do
            [ "$f" = "*" ] && continue
            [ "$f" = ".[!.]*" ] && continue
            ALLOWED=false
            for a in $ALLOWLIST; do
              if [ "$f" = "$a" ]; then
                ALLOWED=true
                break
              fi
            done
            if [ "$ALLOWED" = "false" ]; then
              echo "NOTE: Unexpected item in root: $f"
              WARNINGS=$((WARNINGS + 1))
            fi
          done
          echo "Root hygiene check complete ($WARNINGS notes)"

  # ==========================================================================
  # Policy and Redaction Tests
  # ==========================================================================
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git base-devel rustup
          rustup default stable

      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-arch-cargo-security-${{ hashFiles('**/Cargo.lock') }}

      - name: Run redaction tests
        run: cargo test --package anna_common -- redaction

      - name: Run policy tests
        run: cargo test --package anna_common -- policy

      - name: Run reliability tests
        run: cargo test --package anna_common -- reliability

  # ==========================================================================
  # Final Gate
  # ==========================================================================
  ci-pass:
    name: CI Pass
    runs-on: ubuntu-latest
    needs: [build, test, smoke, hygiene, security-tests]
    # Note: clippy, fmt, audit are advisory and not blocking
    steps:
      - name: All checks passed
        run: |
          echo "=========================================="
          echo "  All CI checks passed"
          echo "  Ready for merge (Arch Linux verified)"
          echo "=========================================="
