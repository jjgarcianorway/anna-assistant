name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Check required files exist
  required-files:
    name: Required Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check VERSION exists and is valid
        run: |
          if [ ! -f VERSION ]; then
            echo "ERROR: VERSION file missing"
            exit 1
          fi
          VERSION=$(cat VERSION | tr -d '[:space:]')
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Invalid version format: $VERSION"
            exit 1
          fi
          echo "VERSION: $VERSION"

      - name: Check required files
        run: |
          files=(
            "SPEC.md"
            "CHANGELOG.md"
            "RELEASE_CONTRACT.md"
            "scripts/install.sh"
            "scripts/uninstall.sh"
            "scripts/release.sh"
            "docs/UPDATE_PROTOCOL.md"
          )
          missing=0
          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Missing required file: $file"
              missing=1
            else
              echo "OK: $file"
            fi
          done
          exit $missing

      - name: Check scripts are executable
        run: |
          for script in scripts/*.sh; do
            if [ ! -x "$script" ]; then
              echo "ERROR: $script is not executable"
              exit 1
            fi
            echo "OK: $script is executable"
          done

  # Check 400-line limit
  line-limit:
    name: 400-Line Limit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check file line counts
        run: |
          echo "Checking source files for 400-line limit..."
          violations=0

          # Check Rust files
          for file in $(find crates -name "*.rs" -type f); do
            lines=$(wc -l < "$file")
            if [ "$lines" -gt 400 ]; then
              echo "ERROR: $file has $lines lines (limit: 400)"
              violations=1
            else
              echo "OK: $file ($lines lines)"
            fi
          done

          # Check shell scripts
          for file in $(find scripts -name "*.sh" -type f); do
            lines=$(wc -l < "$file")
            if [ "$lines" -gt 400 ]; then
              echo "ERROR: $file has $lines lines (limit: 400)"
              violations=1
            else
              echo "OK: $file ($lines lines)"
            fi
          done

          exit $violations

  # Check CLI surface is locked
  cli-surface:
    name: CLI Surface Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build annactl
        run: cargo build --release -p annactl

      - name: Verify CLI surface
        run: |
          ANNACTL="./target/release/annactl"

          # Test --version works
          $ANNACTL --version

          # Test -V works
          $ANNACTL -V

          # Test help shows only allowed commands
          help_output=$($ANNACTL --help)

          # Allowed commands
          allowed=("status" "uninstall" "reset")
          for cmd in "${allowed[@]}"; do
            if ! echo "$help_output" | grep -q "$cmd"; then
              echo "ERROR: Missing allowed command: $cmd"
              exit 1
            fi
            echo "OK: Found allowed command: $cmd"
          done

          echo "CLI surface check passed"

  # Check version consistency
  version-consistency:
    name: Version Consistency
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check version consistency
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "VERSION file: $VERSION"

          # Check install.sh
          INSTALL_VERSION=$(grep '^VERSION=' scripts/install.sh | cut -d'"' -f2)
          if [ "$INSTALL_VERSION" != "$VERSION" ]; then
            echo "ERROR: scripts/install.sh VERSION=$INSTALL_VERSION doesn't match $VERSION"
            exit 1
          fi
          echo "OK: install.sh version matches"

          echo "Version consistency check passed"

  # Build and test
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build
        run: cargo build --release

      - name: Run tests
        run: cargo test

      - name: Check formatting
        run: cargo fmt --check

      - name: Run clippy
        run: cargo clippy -- -D warnings

  # All checks must pass
  all-checks:
    name: All Checks
    runs-on: ubuntu-latest
    needs: [required-files, line-limit, cli-surface, version-consistency, build]
    steps:
      - name: All checks passed
        run: echo "All CI checks passed!"
