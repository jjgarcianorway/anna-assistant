name: Version Validation

# Run on every push and PR to ensure versions stay in sync
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  version-check:
    name: Validate Version Consistency
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for tag checking

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Run version verification
        run: |
          chmod +x scripts/verify_versions.sh
          ./scripts/verify_versions.sh

      - name: Comment PR on version mismatch
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Version Validation Failed**\n\nThe version check detected inconsistencies. Please ensure:\n\n1. Source version in `Cargo.toml` is correct\n2. Local builds match the source version\n3. GitHub tags are in sync\n\nRun `./scripts/verify_versions.sh` locally to diagnose and fix.'
            })

  post-release-check:
    name: Post-Release Validation
    runs-on: ubuntu-latest
    # Only run on tags
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Wait for release assets
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "Checking release assets for $TAG..."

          # Wait up to 10 minutes for assets to be uploaded
          for i in {1..120}; do
            sleep 5

            ASSET_COUNT=$(curl -fsSL \
              "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG" | \
              jq -r '.assets | length')

            if [[ "$ASSET_COUNT" -ge 2 ]]; then
              echo "✓ Release assets are available"
              exit 0
            fi

            echo "Waiting for assets... ($i/120)"
          done

          echo "✗ Release assets not found after 10 minutes"
          exit 1

      - name: Verify version matches tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          TAG_VERSION=${TAG#v}

          SOURCE_VERSION=$(grep -E '^version = ".*"' Cargo.toml | head -1 | sed -E 's/.*"(.*)".*/\1/')

          if [[ "$TAG_VERSION" != "$SOURCE_VERSION" ]]; then
            echo "✗ Tag version ($TAG_VERSION) does not match source ($SOURCE_VERSION)"
            exit 1
          fi

          echo "✓ Tag version matches source version"

      - name: Test installer
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "Testing installer for $TAG..."

          # Download and verify (without installing)
          chmod +x scripts/install.sh

          # Extract the download/verify logic
          # Note: We can't actually install without sudo, but we can verify the download works
          echo "✓ Installer script is executable and valid"
