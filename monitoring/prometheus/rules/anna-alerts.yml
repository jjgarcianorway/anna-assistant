# Anna Assistant Alert Rules
# Prometheus alerting rules for system monitoring
# Generated by Anna Assistant

groups:
  - name: anna_system_alerts
    interval: 60s
    rules:
      # Memory Alerts
      - alert: HighMemoryUsage
        expr: (anna_system_memory_total_mb - anna_system_memory_available_mb) / anna_system_memory_total_mb > 0.9
        for: 5m
        labels:
          severity: warning
          category: resources
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is above 90% for 5 minutes (currently {{ $value | humanizePercentage }})"

      - alert: CriticalMemoryUsage
        expr: (anna_system_memory_total_mb - anna_system_memory_available_mb) / anna_system_memory_total_mb > 0.95
        for: 2m
        labels:
          severity: critical
          category: resources
        annotations:
          summary: "Critical memory usage"
          description: "Memory usage is above 95% for 2 minutes (currently {{ $value | humanizePercentage }})"

      # Disk Alerts
      - alert: LowDiskSpace
        expr: anna_system_disk_available_gb / anna_system_disk_total_gb < 0.1
        for: 1m
        labels:
          severity: warning
          category: resources
        annotations:
          summary: "Low disk space"
          description: "Less than 10% disk space remaining ({{ $value | humanize }} GB available)"

      - alert: CriticalDiskSpace
        expr: anna_system_disk_available_gb / anna_system_disk_total_gb < 0.05
        for: 1m
        labels:
          severity: critical
          category: resources
        annotations:
          summary: "Critical disk space"
          description: "Less than 5% disk space remaining ({{ $value | humanize }} GB available)"

      # System State Alerts
      - alert: SystemDegraded
        expr: anna_system_state == 1
        for: 10m
        labels:
          severity: warning
          category: health
        annotations:
          summary: "System in degraded state"
          description: "Anna detected system degradation for 10 minutes. Run 'annactl doctor' to diagnose."

      - alert: SystemCritical
        expr: anna_system_state == 2
        for: 5m
        labels:
          severity: critical
          category: health
        annotations:
          summary: "System in critical state"
          description: "Anna detected critical system issues for 5 minutes. Immediate action required!"

      # Resource Constraint Alerts
      - alert: ResourceConstrained
        expr: anna_profile_constrained == 1
        for: 15m
        labels:
          severity: info
          category: resources
        annotations:
          summary: "System resource constrained"
          description: "System has been resource-constrained for 15 minutes. Consider closing applications or upgrading hardware."

      # Monitoring Mode Alerts
      - alert: MonitoringModeDowngraded
        expr: changes(anna_profile_mode[10m]) < 0
        for: 1m
        labels:
          severity: info
          category: monitoring
        annotations:
          summary: "Monitoring mode downgraded"
          description: "Anna automatically downgraded monitoring mode due to resource constraints."

  - name: anna_consensus_alerts
    interval: 30s
    rules:
      # Consensus health (Phase 1.7+ only)
      - alert: ConsensusLeaderElection
        expr: rate(anna_consensus_leader_elections_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          category: consensus
        annotations:
          summary: "Frequent leader elections detected"
          description: "Leader elections occurring more than once every 5 minutes. Check network stability."

      - alert: ConsensusReplicationLag
        expr: anna_consensus_replication_lag_entries > 100
        for: 5m
        labels:
          severity: warning
          category: consensus
        annotations:
          summary: "High replication lag"
          description: "Follower is lagging behind leader by {{ $value }} entries."

  - name: anna_action_alerts
    interval: 60s
    rules:
      # Action failure alerts (requires action_history metrics - Phase 3.6+)
      - alert: HighActionFailureRate
        expr: rate(anna_actions_failed_total[1h]) / rate(anna_actions_total[1h]) > 0.2
        for: 10m
        labels:
          severity: warning
          category: actions
        annotations:
          summary: "High action failure rate"
          description: "More than 20% of actions are failing in the last hour ({{ $value | humanizePercentage }})"

      - alert: NoRecentActions
        expr: increase(anna_actions_total[24h]) == 0
        for: 1h
        labels:
          severity: info
          category: actions
        annotations:
          summary: "No actions in 24 hours"
          description: "Anna has not performed any actions in the last 24 hours. System may be idle or daemon may be stopped."

  - name: anna_probe_alerts
    interval: 60s
    rules:
      # Probe failure alerts (requires probe metrics - Phase 3.6+)
      - alert: ProbeFailures
        expr: anna_failed_probes_count > 0
        for: 5m
        labels:
          severity: warning
          category: health
        annotations:
          summary: "Failed health probes detected"
          description: "{{ $value }} health probes are failing. Run 'annactl health' for details."

      - alert: CriticalProbeFailures
        expr: anna_failed_probes_count > 3
        for: 2m
        labels:
          severity: critical
          category: health
        annotations:
          summary: "Multiple critical probe failures"
          description: "{{ $value }} health probes are failing. Run 'annactl doctor' immediately."
