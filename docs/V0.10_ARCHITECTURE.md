# Anna v0.10 Architecture: Telemetry-First MVP

**Philosophy**: Observe first, understand second, act last.

## Design Principles

1. **Read-only by design**: No actuation, no sudo calls, no system modifications
2. **Unprivileged execution**: Run as dedicated `anna` user, not root
3. **Minimal footprint**: <1% CPU average, <80MB RAM
4. **Beautiful CLI**: Pretty tables by default, JSON on --json flag
5. **Privacy-aware**: Redact MACs, IPs, paths; no PII capture
6. **Reliable installation**: Idempotent, meaningful output, graceful degradation

## Component Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                       User Space                             │
│                                                               │
│  ┌──────────────┐         ┌──────────────────────────────┐  │
│  │   annactl    │────────▶│  /run/anna/annad.sock        │  │
│  │  (CLI tool)  │  JSON   │  (UNIX socket)               │  │
│  │              │  -RPC   │                              │  │
│  └──────────────┘         └──────────┬───────────────────┘  │
│                                       │                      │
│                           ┌───────────▼────────────┐         │
│                           │       annad            │         │
│                           │  (systemd service)     │         │
│                           │  User=anna             │         │
│                           │                        │         │
│                           │  ┌──────────────────┐  │         │
│                           │  │ Telemetry        │  │         │
│                           │  │ Collector        │  │         │
│                           │  │ (30s±5s poll)    │  │         │
│                           │  └────────┬─────────┘  │         │
│                           │           │            │         │
│                           │  ┌────────▼─────────┐  │         │
│                           │  │ SQLite Storage   │  │         │
│                           │  │ + Ring Buffer    │  │         │
│                           │  └────────┬─────────┘  │         │
│                           │           │            │         │
│                           │  ┌────────▼─────────┐  │         │
│                           │  │ Persona Radar    │  │         │
│                           │  │ Engine           │  │         │
│                           │  └──────────────────┘  │         │
│                           └────────────────────────┘         │
│                                       │                      │
│                           ┌───────────▼────────────┐         │
│                           │ /var/lib/anna/         │         │
│                           │   telemetry.db         │         │
│                           │   (SQLite)             │         │
│                           └────────────────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## Data Collection (Read-Only)

### System Metrics Collected

| Category | Metrics | Source | Privacy |
|----------|---------|--------|---------|
| **CPU** | Per-core utilization %, load averages, throttle flags | /proc/stat, /proc/loadavg | None |
| **Memory** | Total/used/free/cached, swap usage | /proc/meminfo | None |
| **Temps** | CPU, GPU, NVMe, chassis temps | hwmon, thermal_zone | None |
| **Disk** | Usage %, inodes %, IO stats, SMART summary | /proc/mounts, /sys/block, smartctl | Paths visible |
| **Battery** | %, status, time estimates, power source | /sys/class/power_supply | None |
| **Network** | Per-interface rx/tx rates, link state, RSSI, VPN flag | /sys/class/net, /proc/net | IP last octet redacted, MAC hashed |
| **GPU** | Utilization %, temp | /sys/class/drm, /proc (sysfs only) | None |
| **Processes** | Top N by CPU/RAM, systemd units active/failed | /proc | Process names visible |
| **Inventory** | CPU model, RAM size, disk models, PCI/USB devices | /proc/cpuinfo, lspci, lsusb | Serial numbers stripped |

### Collection Schedule

- **Interval**: 30 seconds ± 5 seconds jitter
- **Failure backoff**: Exponential (30s → 60s → 120s → max 300s)
- **Ring buffer**: Last 60 samples in memory (~30 minutes)
- **Persistence**: All samples to SQLite for historical analysis

## Storage Schema

### SQLite Tables

```sql
-- Core snapshot metadata
CREATE TABLE snapshot (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ts INTEGER NOT NULL,  -- Unix timestamp
    host_id TEXT NOT NULL,  -- Hashed hostname
    kernel TEXT,
    distro TEXT,
    uptime_s INTEGER
);

-- CPU metrics (per-core)
CREATE TABLE cpu (
    ts INTEGER NOT NULL,
    core INTEGER NOT NULL,
    util_pct REAL,
    temp_c REAL,
    PRIMARY KEY (ts, core)
);

-- Memory metrics
CREATE TABLE mem (
    ts INTEGER PRIMARY KEY,
    total_mb INTEGER,
    used_mb INTEGER,
    free_mb INTEGER,
    cached_mb INTEGER,
    swap_total_mb INTEGER,
    swap_used_mb INTEGER
);

-- Disk metrics (per mount)
CREATE TABLE disk (
    ts INTEGER NOT NULL,
    mount TEXT NOT NULL,
    device TEXT,
    fstype TEXT,
    total_gb REAL,
    used_gb REAL,
    pct REAL,
    inodes_pct REAL,
    read_iops INTEGER,
    write_iops INTEGER,
    PRIMARY KEY (ts, mount)
);

-- Network metrics (per interface)
CREATE TABLE net (
    ts INTEGER NOT NULL,
    iface TEXT NOT NULL,
    rx_kbps REAL,
    tx_kbps REAL,
    link_state TEXT,
    ipv4_redacted TEXT,
    ipv6_prefix TEXT,
    mac_hash TEXT,
    rssi_dbm INTEGER,
    ssid_hash TEXT,
    vpn_flag INTEGER,
    PRIMARY KEY (ts, iface)
);

-- Power/Battery metrics
CREATE TABLE power (
    ts INTEGER PRIMARY KEY,
    percent INTEGER,
    status TEXT,  -- Charging, Discharging, Full, Unknown
    on_ac_bool INTEGER,
    time_to_empty_min INTEGER,
    time_to_full_min INTEGER,
    power_now_w REAL
);

-- GPU metrics
CREATE TABLE gpu (
    ts INTEGER NOT NULL,
    device_id TEXT NOT NULL,
    util_pct REAL,
    temp_c REAL,
    mem_used_mb INTEGER,
    mem_total_mb INTEGER,
    PRIMARY KEY (ts, device_id)
);

-- Process snapshots (top N)
CREATE TABLE process (
    ts INTEGER NOT NULL,
    pid INTEGER NOT NULL,
    name TEXT,
    cpu_pct REAL,
    mem_mb REAL,
    state TEXT,
    PRIMARY KEY (ts, pid)
);

-- Systemd unit states
CREATE TABLE systemd_unit (
    ts INTEGER NOT NULL,
    unit TEXT NOT NULL,
    load TEXT,
    active TEXT,
    sub TEXT,
    PRIMARY KEY (ts, unit)
);

-- Alert/anomaly log
CREATE TABLE alerts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ts INTEGER NOT NULL,
    level TEXT,  -- INFO, WARN, ERROR
    component TEXT,
    message TEXT
);

-- Persona scores
CREATE TABLE persona_scores (
    ts INTEGER NOT NULL,
    name TEXT NOT NULL,
    score REAL,  -- 0.0 to 10.0
    evidence_json TEXT,
    PRIMARY KEY (ts, name)
);

-- Inventory (updated on change only)
CREATE TABLE inventory (
    ts INTEGER PRIMARY KEY,
    cpu_model TEXT,
    cpu_cores INTEGER,
    ram_gb INTEGER,
    distro TEXT,
    kernel TEXT,
    devices_json TEXT
);
```

### Indexes for Performance

```sql
CREATE INDEX idx_snapshot_ts ON snapshot(ts);
CREATE INDEX idx_cpu_ts ON cpu(ts);
CREATE INDEX idx_mem_ts ON mem(ts);
CREATE INDEX idx_disk_ts ON disk(ts);
CREATE INDEX idx_net_ts ON net(ts);
CREATE INDEX idx_power_ts ON power(ts);
CREATE INDEX idx_gpu_ts ON gpu(ts);
CREATE INDEX idx_process_ts ON process(ts);
CREATE INDEX idx_alerts_ts ON alerts(ts);
CREATE INDEX idx_persona_ts ON persona_scores(ts);
```

## JSON-RPC API (UNIX Socket)

**Socket**: `/run/anna/annad.sock`
**Protocol**: Line-delimited JSON (request → response)
**Permissions**: 0660 root:anna

### Methods

#### 1. Telemetry.Snapshot
Returns the latest telemetry snapshot.

**Request**:
```json
{
  "jsonrpc": "2.0",
  "method": "Telemetry.Snapshot",
  "params": {
    "pretty": false
  },
  "id": 1
}
```

**Response**:
```json
{
  "jsonrpc": "2.0",
  "result": {
    "ts": 1730390400,
    "uptime_s": 86400,
    "cpu": {
      "cores": [{"core": 0, "util_pct": 12.3, "temp_c": 42.1}, ...],
      "load_avg": [1.2, 1.5, 1.8]
    },
    "mem": {"total_mb": 16384, "used_mb": 8192, ...},
    "disk": [{"mount": "/", "pct": 42.5, ...}],
    "net": [{"iface": "eth0", "rx_kbps": 120.5, ...}],
    "power": {"percent": 91, "status": "Charging", ...},
    "gpu": [{"device": "0", "util_pct": 5.2, ...}]
  },
  "id": 1
}
```

#### 2. Telemetry.History
Returns historical data over a time window.

**Request**:
```json
{
  "jsonrpc": "2.0",
  "method": "Telemetry.History",
  "params": {
    "window_min": 60,
    "metrics": ["cpu", "mem"]
  },
  "id": 2
}
```

#### 3. Telemetry.Trends
Returns computed trends for a metric.

**Request**:
```json
{
  "jsonrpc": "2.0",
  "method": "Telemetry.Trends",
  "params": {
    "metric": "cpu_util",
    "window_min": 30
  },
  "id": 3
}
```

**Response**:
```json
{
  "jsonrpc": "2.0",
  "result": {
    "metric": "cpu_util",
    "mean": 15.2,
    "p50": 12.3,
    "p95": 45.6,
    "p99": 78.9,
    "trend": "stable"
  },
  "id": 3
}
```

#### 4. Health.Summary
Returns one-screen health overview.

**Request**:
```json
{
  "jsonrpc": "2.0",
  "method": "Health.Summary",
  "params": {},
  "id": 4
}
```

**Response**:
```json
{
  "jsonrpc": "2.0",
  "result": {
    "status": "healthy",
    "components": [
      {"name": "cpu", "state": "ok", "detail": "42.1°C avg, 15% util"},
      {"name": "mem", "state": "ok", "detail": "50% used"},
      {"name": "disk", "state": "warn", "detail": "/ at 85%"},
      {"name": "thermal", "state": "ok", "detail": "All zones < 75°C"}
    ]
  },
  "id": 4
}
```

#### 5. Persona.Scores
Returns current persona radar scores.

**Request**:
```json
{
  "jsonrpc": "2.0",
  "method": "Persona.Scores",
  "params": {},
  "id": 5
}
```

**Response**:
```json
{
  "jsonrpc": "2.0",
  "result": {
    "ts": 1730390400,
    "scores": [
      {"name": "Minimalist", "score": 7.2, "evidence": ["tmux", "vim", "alpine"]},
      {"name": "PowerUser", "score": 8.5, "evidence": ["zsh", "neovim", "i3wm"]},
      {"name": "Server", "score": 3.1, "evidence": ["sshd", "uptime 30d"]},
      {"name": "Workstation", "score": 6.8, "evidence": ["firefox", "vscode"]},
      {"name": "TilingWM", "score": 9.2, "evidence": ["i3", "polybar", "rofi"]},
      {"name": "HeavyDesktop", "score": 2.3, "evidence": []},
      {"name": "TerminalFocus", "score": 8.7, "evidence": ["70% TTY time"]},
      {"name": "AutomationAffinity", "score": 7.9, "evidence": ["cron", "systemd timers"]}
    ]
  },
  "id": 5
}
```

## Persona Radar System

### Eight Persona Dimensions

Each scored 0.0–10.0 based on observable system characteristics.

| Persona | Evidence Signals |
|---------|------------------|
| **Minimalist** | Alpine/Void distro, <100 packages, tmux/vim, no GUI |
| **PowerUser** | Zsh/Fish, Neovim/Emacs, tiling WM, dotfile repos, custom keybinds |
| **Server** | SSH daemon, high uptime, no GUI, cron jobs, monitoring tools |
| **Workstation** | KDE/GNOME, Firefox/Chrome, office suite, Steam, media players |
| **TilingWM** | i3/sway/bspwm/awesome, polybar/waybar, rofi/dmenu |
| **HeavyDesktop** | Electron apps, >4GB GUI mem, Plasma, compositing effects |
| **TerminalFocus** | >60% CPU in terminal emulators, shell-heavy history |
| **AutomationAffinity** | Systemd timers, Ansible, scripts in /home, Git hooks |

### Scoring Algorithm

```rust
fn score_minimalist(evidence: &SystemEvidence) -> (f32, Vec<String>) {
    let mut score = 5.0;  // Baseline
    let mut reasons = Vec::new();

    if evidence.distro.is_minimal() {
        score += 2.0;
        reasons.push("Minimal distro detected");
    }
    if evidence.package_count < 100 {
        score += 2.0;
        reasons.push("<100 packages installed");
    }
    if evidence.has_program("tmux") && evidence.has_program("vim") {
        score += 1.0;
        reasons.push("tmux+vim combo");
    }
    if !evidence.has_gui_session() {
        score += 1.0;
        reasons.push("No GUI session");
    }

    (score.min(10.0), reasons)
}
```

## CLI Commands

All commands support `--json` flag for machine-readable output.

### annactl status
One-screen system health overview.

**Pretty output**:
```
🟢 Anna status

Component     State      Detail
-----------   --------   -----------------------------
Daemon        running    PID 2142, 0.2% CPU, 24 MB RAM
Sensors       ready      CPU 42.1°C, NVMe 39°C, Batt 91%
Network       ok         eth0 120↓/9↑ kbps, vpn: off
Storage       ok         / 42% used, /home 55% used

✅ System healthy, telemetry rolling
```

### annactl sensors
Quick sensor readout (temps, fans, battery, power).

**Pretty output**:
```
🌡️  Sensors

Sensor           Value      Status
--------------   --------   ------
CPU Package      42.1°C     ✅ OK
CPU Core 0       41.8°C     ✅ OK
CPU Core 1       42.4°C     ✅ OK
NVMe             39.2°C     ✅ OK
GPU              35.0°C     ✅ OK
Battery          91%        🔌 Charging
Power Draw       18.5W      ⚡ AC

All sensors nominal
```

### annactl top
Top processes by CPU/RAM.

**Pretty output**:
```
📊 Top Processes

PID      Name              CPU%   RAM (MB)
------   ---------------   ----   --------
12450    firefox           45.2   1250
8821     code              12.8   890
2142     annad             0.2    24
1        systemd           0.1    15

Total: 245 processes, 4 shown
```

### annactl net
Per-interface network statistics.

**Pretty output**:
```
🌐 Network

Interface   State    RX (kbps)   TX (kbps)   IP (redacted)   VPN
---------   ------   ---------   ---------   -------------   ---
eth0        up       120.5       9.2         192.168.1.xxx   ❌
wlan0       down     0.0         0.0         —               ❌

2 interfaces, 1 active
```

### annactl disk
Disk usage and inode statistics.

**Pretty output**:
```
💾 Disk Usage

Mount      Device        Size    Used    Free    %      Inodes%
--------   -----------   -----   -----   -----   ----   -------
/          /dev/nvme0n1  500GB   210GB   290GB   42%    18%
/home      /dev/nvme0n2  1TB     550GB   450GB   55%    12%

2 filesystems, all OK
```

### annactl radar show
Display persona radar scores.

**Pretty output**:
```
🎯 Persona Radar

Persona             Score   ██████████
-----------------   -----   ──────────────────────
Minimalist          7.2/10  ███████▏
PowerUser           8.5/10  ████████▌
Server              3.1/10  ███
Workstation         6.8/10  ██████▊
TilingWM            9.2/10  █████████▏
HeavyDesktop        2.3/10  ██▎
TerminalFocus       8.7/10  ████████▋
AutomationAffinity  7.9/10  ███████▉

Computed at 2025-10-31 12:00:00
```

### annactl radar why <name>
Show evidence for a specific persona score.

**Pretty output**:
```
🔍 Persona: TilingWM (9.2/10)

Evidence:
  ✅ i3 window manager detected
  ✅ polybar status bar running
  ✅ rofi launcher present
  ✅ No compositing effects
  ✅ <10ms average window spawn

Last updated: 2 minutes ago
```

### annactl export <file.json>
Export latest snapshot bundle to JSON file.

**Output**:
```
📦 Exporting telemetry snapshot...

Exported:
  - System info
  - CPU metrics (8 cores)
  - Memory metrics
  - Disk metrics (2 mounts)
  - Network metrics (2 interfaces)
  - Power metrics
  - Process list (top 50)
  - Persona scores

Written to: snapshot_2025-10-31_120000.json (124 KB)
```

## Privacy & Redaction

### What We Redact

| Data Type | Original | Redacted |
|-----------|----------|----------|
| IPv4 addresses | 192.168.1.42 | 192.168.1.xxx |
| IPv6 addresses | 2001:db8::1 | 2001:db8::/64 |
| MAC addresses | aa:bb:cc:dd:ee:ff | sha256(mac)[0:16] |
| WiFi SSIDs | MyHomeNetwork | sha256(ssid)[0:16] |
| Hostnames | johns-laptop | sha256(hostname)[0:16] |
| Serial numbers | ABC123XYZ | [REDACTED] |
| Home paths | /home/john/docs | /home/[user]/docs |

### What We DON'T Collect

- File contents
- Command-line arguments containing secrets
- Environment variables
- Browser history or bookmarks
- Document names or directory listings
- Email addresses or contact info
- Credentials or API keys

## Performance Budget

### Target Metrics

- **CPU**: <1% average, <5% peak during collection
- **Memory**: <80MB RSS steady-state
- **Disk I/O**: <10 KB/s sustained
- **Collection time**: <500ms per poll cycle
- **CLI response time**: <200ms for `annactl status`

### Performance Optimizations

1. **Incremental updates**: Only read changed data
2. **Bulk inserts**: Batch SQLite writes (60s windows)
3. **Lazy parsing**: Parse only requested fields
4. **Ring buffer**: Keep last 60 samples in RAM
5. **Connection pooling**: Reuse socket connections
6. **Smart jitter**: Spread polls to avoid contention

## Installation Flow

### scripts/install.sh Phases

#### Phase 1: Preflight
- Check if running as root
- Detect existing Anna installation
- Verify required commands: systemctl, sqlite3
- Check optional deps: lm-sensors, smartmontools, sensors-detect

#### Phase 2: User & Directories
- Create `anna` system user (no login)
- Create groups: `anna`
- Create directories:
  - `/etc/anna/` (config)
  - `/var/lib/anna/` (state)
  - `/var/log/anna/` (logs)
  - `/run/anna/` (runtime)

#### Phase 3: Optional Dependencies
- Detect package manager (pacman, apt, dnf, zypper)
- Offer to install optional deps
- Continue if declined or unavailable

#### Phase 4: Binary Installation
- Build release binaries: `cargo build --release`
- Install to `/usr/local/bin/`:
  - `annad`
  - `annactl`
- Set permissions: 0755

#### Phase 5: Systemd Service
- Install unit file: `/etc/systemd/system/annad.service`
- daemon-reload
- Enable annad.service
- Start annad.service
- Verify active state

#### Phase 6: Verification
- Wait 5 seconds for daemon startup
- Run `annactl status` to verify communication
- Check `/var/lib/anna/telemetry.db` exists
- Print success message or actionable error

### Success Criteria

All must pass for green checkmark:

1. `systemctl is-active annad` → `active`
2. `/run/anna/annad.sock` exists and is writable by `anna` group
3. `annactl status` returns JSON without error
4. Daemon CPU <1%, RAM <80MB
5. Database initialized with schema

### Error Codes

| Code | Meaning | Action |
|------|---------|--------|
| 10 | Preflight failed | Check requirements |
| 20 | Build failed | Check cargo/rustc |
| 30 | Service failed | Check `journalctl -u annad` |
| 40 | Verification failed | Run `annactl doctor check` |

## Security Considerations

### Threat Model

**In scope**:
- Unprivileged local user reading telemetry
- Accidental PII exposure in logs
- Resource exhaustion (CPU/RAM/disk)

**Out of scope** (v0.10):
- Network attacks (no network exposure)
- Privilege escalation (no actuation, no sudo)
- Malicious input to annactl (defense in depth TBD)

### Mitigations

1. **Least privilege**: Run as `anna` user, no capabilities
2. **Namespacing**: Use RuntimeDirectory/StateDirectory
3. **Socket permissions**: 0660 root:anna on UNIX socket
4. **Input validation**: Sanitize all /proc and /sys reads
5. **Rate limiting**: Max 1 collection/sec, backoff on failure
6. **Log rotation**: Cap at 100MB per log file
7. **No code execution**: No shell-out, no eval, no dynamic loading

## Testing Strategy

### Unit Tests
- Telemetry parser correctness
- Privacy redaction functions
- Persona scoring logic
- SQLite schema migrations

### Integration Tests
- Daemon startup and shutdown
- Socket communication (RPC round-trips)
- CLI command execution
- Database persistence

### Smoke Test (tests/smoke.sh)
```bash
#!/bin/bash
set -euo pipefail

# Build
cargo build --release

# Install (temporary test environment)
./scripts/install.sh --test-mode

# Verify daemon running
systemctl is-active annad || exit 30

# Test all CLI commands
annactl status
annactl sensors
annactl top
annactl net
annactl disk
annactl radar show
annactl export /tmp/test-export.json

# Test JSON mode
annactl status --json | jq .
annactl radar show --json | jq .

# Performance check
PID=$(pgrep annad)
CPU=$(ps -p $PID -o %cpu= | awk '{print int($1)}')
MEM=$(ps -p $PID -o rss= | awk '{print int($1/1024)}')

[ "$CPU" -lt 2 ] || { echo "CPU too high: $CPU%"; exit 41; }
[ "$MEM" -lt 100 ] || { echo "RAM too high: ${MEM}MB"; exit 42; }

echo "✅ All smoke tests passed"
```

### Performance Benchmark
```bash
#!/bin/bash
# Measure steady-state resource usage over 5 minutes
PID=$(pgrep annad)
for i in {1..300}; do
  ps -p $PID -o %cpu=,rss= >> /tmp/anna-perf.csv
  sleep 1
done

awk '{cpu+=$1; mem+=$2; n++} END {
  print "Avg CPU:", cpu/n "%"
  print "Avg RAM:", int(mem/n/1024) "MB"
}' /tmp/anna-perf.csv
```

## Documentation Deliverables

### docs/GETTING_STARTED.md
Quick installation and first commands (500 lines max).

### docs/TELEMETRY_SCHEMA.md
Complete SQLite schema with examples (800 lines).

### docs/RADARS.md
Persona scoring methodology and evidence sources (600 lines).

## Success Metrics (Acceptance Criteria)

All must pass before v0.10 release:

- [ ] Fresh VM: `scripts/install.sh` → prints `✅ Anna is ready`
- [ ] `systemctl is-active annad` → `active`
- [ ] `annactl status` completes <200ms, shows correct fields
- [ ] `annactl radar show` prints 8 scores with reasons
- [ ] `annactl status --json` outputs valid JSON (jq validates)
- [ ] Idle overhead: <1% CPU, <80MB RAM (measured over 5min)
- [ ] No actuation commands exist in codebase (grep confirms)
- [ ] All smoke tests pass (`./tests/smoke.sh`)
- [ ] Documentation complete and accurate

## Non-Goals for v0.10

These are explicitly deferred to future releases:

- ❌ Actuation (fan control, governor changes, fixes)
- ❌ Root/sudo operations
- ❌ Network exposure (HTTP API, remote telemetry)
- ❌ Machine learning predictions
- ❌ Policy-based automation
- ❌ Interactive TUI or web UI
- ❌ Multi-host aggregation
- ❌ Plugin system

---

**Version**: v0.10.0
**Status**: In Development
**Last Updated**: 2025-10-31
