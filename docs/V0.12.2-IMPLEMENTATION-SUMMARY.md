# Anna v0.12.2 Implementation Summary

## Overview

Version 0.12.2 introduces focused collectors, radar scoring systems, and new RPC endpoints for telemetry and classification. This release maintains all v0.12.1 stability guarantees while adding powerful system profiling capabilities.

## Key Features

### 1. Focused Collectors (`collectors_v12.rs`)

Lightweight collectors for system telemetry:

- **Sensors**: CPU load, memory usage, temperatures, battery
- **Network**: Interface stats, default route, DNS latency
- **Disk**: Mount points, usage, headroom
- **Top**: Process rankings by CPU and memory

All collectors handle missing data gracefully with optional fields.

### 2. Radar Scoring System (`radars_v12.rs`)

Two radar systems that compute 0-10 scores:

#### Health Radar
- `cpu_load`: System load assessment (10 = idle, 0 = overloaded)
- `mem_pressure`: Memory availability (10 = plenty free, 0 = full)
- `disk_headroom`: Disk space (10 = empty, 0 = full)
- `thermal_ok`: Temperature health (10 = cool, 0 = hot)

#### Network Radar
- `latency`: Network latency (10 = <20ms, 0 = >250ms)
- `loss`: Packet loss (10 = 0%, 0 = >10%)
- `dns_reliability`: DNS success (binary 10/0)

### 3. New RPC Endpoints

Three new JSON-RPC methods in `rpc_v10.rs`:

```json
// collect: Get telemetry snapshots
{
  "method": "collect",
  "params": { "limit": 1 }
}

// classify: System persona classification
{
  "method": "classify",
  "params": {}
}

// radar_show: Radar scores
{
  "method": "radar_show",
  "params": {}
}
```

### 4. CLI Commands

Three new `annactl` commands:

```bash
# Collect telemetry
annactl collect --limit 1 --json

# Classify system
annactl classify --json

# Show radar scores
annactl radar show --json
```

All support both human-readable and `--json` output.

## Implementation Details

### Non-Regression

- Preserved all v0.12.1 timeouts (2s/2s/5s)
- Maintained exit code 7 on timeout
- Kept watchdog heartbeat (10s interval)
- Preserved systemd hardening

### Error Handling

- All RPC methods return `Result<Value, Error>`
- Missing sensors return `Option::None` without failing
- Network failures degrade gracefully
- Clear error messages for debugging

### Database Schema

New tables in `/var/lib/anna/telemetry.db`:

- `snapshots`: Telemetry data (JSON, 1000 most recent)
- `radar_scores`: Computed scores (7-day retention)
- `classifications`: System personas (7-day retention)

## Testing

### Smoke Test (`tests/smoke_v0122.sh`)

Validates:
1. `annactl status` works
2. `annactl collect --limit 1 --json` returns valid JSON
3. `annactl classify --json` returns persona
4. `annactl radar show --json` returns scores
5. Human output for all commands

Run: `sudo ./tests/smoke_v0122.sh`

## Files Changed

### New Files
- `src/annad/src/collectors_v12.rs` (404 lines)
- `src/annad/src/radars_v12.rs` (408 lines)
- `src/annad/src/telemetry_schema_v12.sql` (52 lines)
- `tests/smoke_v0122.sh` (95 lines)
- `docs/V0.12.2-IMPLEMENTATION-SUMMARY.md` (this file)
- `docs/CLI-REFERENCE-v0122.md`

### Modified Files
- `src/annad/src/main.rs`: Added module declarations
- `src/annad/src/rpc_v10.rs`: Added 3 RPC methods (140 lines)
- `src/annactl/src/main.rs`: Added 3 commands + print functions (180 lines)
- `Cargo.toml`: Version bump to 0.12.2
- `CHANGELOG.md`: v0.12.2 entry

## Verification

```bash
# Build
cargo build --release --bin annad
cargo build --release --bin annactl

# Deploy
sudo cp target/release/{annad,annactl} /usr/local/bin/
sudo systemctl restart annad

# Test
annactl status
annactl collect --limit 1 --json | jq '.snapshots[0]'
annactl classify --json | jq '.persona'
annactl radar show --json | jq '.overall'

# Smoke test
sudo ./tests/smoke_v0122.sh
```

## Acceptance Criteria

✓ All three new commands work in human and JSON mode
✓ Timeouts and exit-7 behavior preserved
✓ No panics, graceful degradation
✓ Clean logs (info/warn only)
✓ Smoke test passes
✓ JSON schemas stable

## Next Steps

Future enhancements:
- Persistent telemetry history queries
- Trend analysis over time
- Alerting thresholds
- ML-based persona detection
- Integration with event system
