# Anna v0.11.0 Installation Fixes

## Problem Summary

Anna v0.11.0 installations were experiencing the following issues:

1. **Missing RPC socket** at `/run/anna/annad.sock`
2. **SQLite database readonly error** when annad tries to write to `/var/lib/anna/telemetry.db`
3. **Missing CAPABILITIES.toml** file warning
4. **Incorrect directory ownership** causing permission denied errors

## Root Causes

1. **systemd unit incomplete**: Only had `RuntimeDirectory=anna` but missing `StateDirectory` and `LogsDirectory`, leading to inconsistent directory management
2. **Installer ownership bugs**: Directories sometimes created with root ownership instead of anna:anna
3. **CAPABILITIES.toml not copied**: Installer logic had gaps that prevented the file from being installed
4. **Storage init didn't validate permissions**: annad would attempt DB operations without checking if `/var/lib/anna` was writable
5. **RPC didn't ensure parent directory**: Socket binding failed if `/run/anna` wasn't created yet

## Fixes Applied

### 1. Systemd Unit Hardening (etc/systemd/annad.service)

**Changes:**
```systemd
# Added managed directories
StateDirectory=anna
StateDirectoryMode=0750
LogsDirectory=anna
LogsDirectoryMode=0750
RuntimeDirectory=anna
RuntimeDirectoryMode=0750
UMask=007
```

**Effect:**
- systemd now auto-creates `/var/lib/anna`, `/var/log/anna`, `/run/anna` with correct ownership (anna:anna)
- Directories get mode 0750 automatically
- Consistent behavior across restarts

### 2. Installer Ownership Fixes (scripts/install.sh)

**Changes:**
```bash
# Use install command with explicit ownership
install -d -m 0750 -o anna -g anna /var/lib/anna
install -d -m 0750 -o anna -g anna /var/log/anna
install -d -m 0755 -o root -g root /usr/lib/anna
install -d -m 0755 -o root -g root /etc/anna

# Defensive chown after creation
chown -R anna:anna /var/lib/anna /var/log/anna
chmod 0750 /var/lib/anna /var/log/anna
```

**CAPABILITIES.toml installation:**
```bash
if [ -f etc/CAPABILITIES.toml ]; then
    sudo install -m 0644 -o root -g root etc/CAPABILITIES.toml /usr/lib/anna/CAPABILITIES.toml
elif [ ! -f /usr/lib/anna/CAPABILITIES.toml ]; then
    # Create minimal version if source missing
    ...
fi
```

**Service startup:**
```bash
# Use enable --now to both enable and start
sudo systemctl enable --now annad
sleep 3  # Wait for initialization
```

**Effect:**
- Directories always have correct ownership on fresh installs
- CAPABILITIES.toml guaranteed to exist
- Daemon starts immediately after install

### 3. Storage Init Permission Validation (src/annad/src/storage_v10.rs)

**Changes:**
```rust
pub fn new<P: AsRef<Path>>(db_path: P) -> Result<Self> {
    let db_path = db_path.as_ref();

    // Ensure parent directory exists
    if let Some(parent) = db_path.parent() {
        std::fs::create_dir_all(parent)?;
        Self::check_dir_writable(parent)?;
    }

    let conn = Connection::open(db_path)
        .with_context(|| {
            let metadata_info = if let Ok(md) = std::fs::metadata(db_path) {
                format!("DB exists: uid={} gid={} mode={:o}", ...)
            } else {
                "DB does not exist yet".to_string()
            };
            format!("Failed to open telemetry database at {:?}. {}", db_path, metadata_info)
        })?;
    ...
}

fn check_dir_writable(dir: &Path) -> Result<()> {
    // Create test file to verify write access
    let test_file = dir.join(".writetest");
    match std::fs::write(&test_file, b"test") {
        Ok(_) => {
            let _ = std::fs::remove_file(&test_file);
            Ok(())
        }
        Err(e) => {
            anyhow::bail!(
                "Directory {:?} is not writable: {}. Owner: uid={} gid={} mode={:o}",
                dir, e, uid, gid, mode
            )
        }
    }
}
```

**Effect:**
- annad fails fast with detailed error if `/var/lib/anna` is not writable
- Error messages include uid/gid/mode for troubleshooting
- Prevents silent failures and confusing "readonly database" errors

### 4. RPC Socket Directory Creation (src/annad/src/rpc_v10.rs)

**Changes:**
```rust
pub async fn start<P: AsRef<Path>>(self: Arc<Self>, socket_path: P) -> Result<()> {
    let socket_path = socket_path.as_ref();

    // Ensure parent directory exists (systemd RuntimeDirectory should create it)
    if let Some(parent) = socket_path.parent() {
        if !parent.exists() {
            std::fs::create_dir_all(parent)?;
            info!("Created socket directory: {:?}", parent);
        }
    }

    let listener = UnixListener::bind(socket_path)
        .with_context(|| format!("Failed to bind UNIX socket at {:?}", socket_path))?;
    ...
}
```

**Effect:**
- Socket binding succeeds even if systemd RuntimeDirectory didn't create `/run/anna` yet
- Better error messages with full socket path
- Handles race conditions during startup

### 5. Enhanced Doctor Checks (src/annactl/src/doctor_cmd.rs)

**New checks in `doctor post`:**

1. **CAPABILITIES.toml presence**
2. **Directory ownership**: Verifies `/var/lib/anna` and `/var/log/anna` are owned by anna:anna with mode 0750
3. **Daemon active check**: Ensures annad is running before checking socket
4. **Socket polling**: Waits up to 10 seconds for `/run/anna/annad.sock` to appear
5. **DB write test**: Creates and deletes `/var/lib/anna/.writetest` to verify write access

**Effect:**
- Post-install validation catches permission issues immediately
- Clear warnings guide users to run repair script
- Prevents incomplete installations from appearing successful

### 6. Updated Smoke Tests (tests/smoke_v011.sh)

**Changes:**
```bash
# Test 2.2: Check socket exists (poll up to 15 seconds)
SOCKET_FOUND=false
for i in {1..15}; do
    if [ -S /run/anna/annad.sock ]; then
        SOCKET_FOUND=true
        break
    fi
    sleep 1
done
```

**Effect:**
- Tests no longer fail immediately if socket takes a few seconds to appear
- More reliable CI/CD validation
- Better matches real-world startup timing

### 7. Emergency Repair Script (scripts/fix_v011_installation.sh)

**One-shot repair for broken installs:**

1. Stops annad
2. Fixes directory ownership using `install -d -m 0750 -o anna -g anna`
3. Installs CAPABILITIES.toml from repo or creates minimal version
4. Reloads systemd
5. Restarts annad
6. Polls for socket (up to 10 seconds)
7. Verifies annactl connectivity
8. Reports status with clear pass/fail for each component

**Usage:**
```bash
sudo bash scripts/fix_v011_installation.sh
```

**Effect:**
- One-liner fix for users experiencing socket/permission errors
- Idempotent (safe to run multiple times)
- Comprehensive verification at the end

## Verification Checklist

After applying fixes, verify:

```bash
# 1. Run installer or repair script
./scripts/install.sh
# OR
sudo bash scripts/fix_v011_installation.sh

# 2. Check daemon status
sudo systemctl status annad --no-pager

# 3. Verify directories
ls -ld /var/lib/anna /var/log/anna /usr/lib/anna /etc/anna

# Expected output:
# drwxr-x--- 2 anna anna  ... /var/lib/anna
# drwxr-x--- 2 anna anna  ... /var/log/anna
# drwxr-xr-x 2 root root  ... /usr/lib/anna
# drwxr-xr-x 4 root root  ... /etc/anna

# 4. Check logs for errors
sudo journalctl -u annad -n 20 --no-pager

# 5. Verify socket
test -S /run/anna/annad.sock && echo "Socket exists" || echo "Socket missing"

# 6. Test annactl
annactl status
```

## Expected Behavior After Fixes

1. **Fresh install**: Socket appears within 3-5 seconds of `systemctl start annad`
2. **Upgrade**: Existing databases remain accessible, daemon restarts cleanly
3. **Logs**: No "readonly database" or "permission denied" errors in journalctl
4. **CLI**: `annactl status` returns immediately without "Failed to connect" errors

## Known Limitations

1. **Requires systemd**: StateDirectory/LogsDirectory features need systemd 235+
2. **Arch Linux only** for auto-dependency installation (installer uses pacman)
3. **No automatic migration**: Existing installs with wrong ownership need manual repair

## Troubleshooting

### Socket still missing after repair

```bash
# Check daemon logs for detailed error
sudo journalctl -u annad -n 50 --no-pager | grep -i error

# Common causes:
# 1. Storage init failed (check DB permissions)
# 2. RPC binding failed (check /run/anna exists)
# 3. Daemon crashed during startup (check panic in logs)
```

### Database still readonly

```bash
# Check ownership
ls -la /var/lib/anna/telemetry.db

# Should be:
# -rw-r----- 1 anna anna ... telemetry.db

# Fix:
sudo chown anna:anna /var/lib/anna/telemetry.db
sudo chmod 0640 /var/lib/anna/telemetry.db
```

### CAPABILITIES.toml missing warning persists

```bash
# Manually copy from repo
sudo install -m 0644 -o root -g root etc/CAPABILITIES.toml /usr/lib/anna/CAPABILITIES.toml

# OR create minimal version
sudo tee /usr/lib/anna/CAPABILITIES.toml <<EOF
[meta]
version = "0.11.0"
description = "Anna telemetry capability registry"
EOF
```

## Rollback Instructions

If fixes cause issues, revert with:

```bash
# Stop daemon
sudo systemctl stop annad

# Restore previous systemd unit (if you have backup)
sudo cp /path/to/backup/annad.service /etc/systemd/system/
sudo systemctl daemon-reload

# OR manually remove new directives from /etc/systemd/system/annad.service:
# - Remove StateDirectory, LogsDirectory lines
# - Keep RuntimeDirectory only

# Restart
sudo systemctl start annad
```

## Testing

Run comprehensive validation:

```bash
# Smoke tests
bash tests/smoke_v011.sh

# Doctor checks
annactl doctor post

# Manual verification
systemctl status annad
annactl status
annactl events --limit 5
```

## References

- **systemd directives**: `man systemd.exec` (StateDirectory, LogsDirectory, RuntimeDirectory)
- **SQLite permissions**: https://www.sqlite.org/c3ref/open.html
- **Unix socket security**: `man 7 unix`
