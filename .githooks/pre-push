#!/bin/bash
# Pre-push hook to prevent broken releases
# This ensures we NEVER push code that breaks the socket fix

set -e

echo "ðŸ” Pre-push validation..."
echo ""

# 1. Check socket fix is present
echo "1. Verifying socket ownership fix..."
if ! grep -q "Socket group ownership set to anna" src/annad/src/rpc_v10.rs; then
    echo "   âœ— CRITICAL: Socket fix missing from source!"
    echo "   This would break RPC for all users!"
    exit 1
fi
echo "   âœ“ Socket fix present"

# 2. Check VERSION file matches latest tag
echo "2. Checking VERSION consistency..."
VERSION=$(cat VERSION | tr -d '[:space:]')
LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")

if [ "$LATEST_TAG" != "none" ] && [ "$VERSION" != "$LATEST_TAG" ]; then
    echo "   âš  WARNING: VERSION ($VERSION) != latest tag ($LATEST_TAG)"
    echo "   Did you forget to run ./scripts/release.sh?"
fi

# 3. Check Cargo.toml version matches
CARGO_VERSION=$(grep -E '^\s*version\s*=' Cargo.toml | head -1 | sed -E 's/.*"(.*)".*/\1/')
VERSION_NO_V="${VERSION#v}"

if [ "$CARGO_VERSION" != "$VERSION_NO_V" ]; then
    echo "   âœ— ERROR: Cargo.toml version ($CARGO_VERSION) != VERSION ($VERSION_NO_V)"
    echo "   Run: ./scripts/release.sh to sync versions"
    exit 1
fi
echo "   âœ“ Versions consistent"

# 4. Build check (quick)
echo "3. Quick build check..."
if ! cargo check --bin annad --bin annactl --quiet 2>/dev/null; then
    echo "   âœ— ERROR: Code doesn't compile!"
    echo "   Fix compilation errors before pushing"
    exit 1
fi
echo "   âœ“ Code compiles"

echo ""
echo "âœ… Pre-push validation passed!"
echo ""
