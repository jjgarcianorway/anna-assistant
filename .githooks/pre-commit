#!/usr/bin/env bash
# Anna Assistant Pre-Commit Hook
# Warns about version mismatches before committing

set -e

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
RESET='\033[0m'

# Only run version check if Cargo.toml is being committed
if git diff --cached --name-only | grep -q "^Cargo.toml$"; then
    echo -e "${CYAN}━━━ Running version check... ${RESET}"
    echo ""

    # Get source version
    SOURCE_VERSION=$(grep -E '^version = ".*"' Cargo.toml | head -1 | sed -E 's/.*"(.*)".*/\1/')

    # Check if local build exists and matches
    if [[ -f ./target/release/annactl ]]; then
        BUILD_VERSION=$(./target/release/annactl --version 2>/dev/null | grep -oP 'v?[0-9]+\.[0-9]+\.[0-9]+(-rc\.[0-9]+)?' | head -1 || echo "UNKNOWN")

        if [[ "$BUILD_VERSION" != "$SOURCE_VERSION" && "$BUILD_VERSION" != "UNKNOWN" ]]; then
            echo -e "${YELLOW}⚠ WARNING: Version mismatch detected!${RESET}"
            echo -e "  Source (Cargo.toml): ${CYAN}$SOURCE_VERSION${RESET}"
            echo -e "  Local build:         ${CYAN}$BUILD_VERSION${RESET}"
            echo ""
            echo -e "${YELLOW}Recommendation:${RESET} Rebuild with: ${CYAN}cargo build --release${RESET}"
            echo ""
            echo -e "Continue anyway? [y/N] "
            read -r response
            if [[ ! "$response" =~ ^[Yy]$ ]]; then
                echo -e "${RED}✗ Commit aborted${RESET}"
                exit 1
            fi
        fi
    fi

    # Check if this is a version bump commit
    if git diff --cached Cargo.toml | grep -q '^+version = '; then
        NEW_VERSION=$(git diff --cached Cargo.toml | grep '^+version = ' | sed -E 's/.*"(.*)".*/\1/')
        echo -e "${GREEN}✓ Version bump detected: v${NEW_VERSION}${RESET}"
        echo ""
        echo -e "${CYAN}Post-commit reminders:${RESET}"
        echo -e "  1. Rebuild: ${CYAN}cargo build --release${RESET}"
        echo -e "  2. Test: ${CYAN}./target/release/annactl version${RESET}"
        echo -e "  3. Release: ${CYAN}./scripts/release.sh${RESET}"
        echo ""
    fi
fi

echo -e "${GREEN}✓ Pre-commit checks passed${RESET}"
exit 0
