# Anna Assistant Daemon - Security Hardening Configuration
#
# This is a systemd drop-in configuration file that adds comprehensive
# security hardening to the annad service.
#
# Installation:
#   sudo mkdir -p /etc/systemd/system/annad.service.d/
#   sudo cp annad-hardening.conf /etc/systemd/system/annad.service.d/hardening.conf
#   sudo systemctl daemon-reload
#   sudo systemctl restart annad
#
# IMPORTANT: This configuration requires annad to run with specific capabilities.
# Some hardening features may restrict legitimate functionality if enabled too
# aggressively. Test thoroughly before deploying to production.
#
# Based on: systemd.exec(5) security hardening best practices
# Reference: https://www.freedesktop.org/software/systemd/man/systemd.exec.html

[Service]
# ============================================================================
# PRIVILEGE MANAGEMENT
# ============================================================================

# Run as dedicated user (not root) after binding privileged socket
# TODO: Create 'anna' user and 'annactl' group during installation
# User=anna
# Group=annactl
# SupplementaryGroups=

# Ambient capabilities - keep only what's absolutely necessary
# CAP_DAC_OVERRIDE: Read system files (e.g., /etc/pacman.conf, package database)
# CAP_SYS_ADMIN: Run systemctl commands
# Note: Commented out until we implement proper capability dropping in code
# AmbientCapabilities=CAP_DAC_OVERRIDE CAP_SYS_ADMIN
# CapabilityBoundingSet=CAP_DAC_OVERRIDE CAP_SYS_ADMIN

# Already set in main service file, but ensure it's present
NoNewPrivileges=yes

# ============================================================================
# FILESYSTEM PROTECTION
# ============================================================================

# Make entire filesystem read-only, with exceptions
ProtectSystem=strict

# Specific paths that need write access
ReadWritePaths=/var/log/anna /var/lib/anna

# Protect home directories from access
ProtectHome=yes

# Use private /tmp (already set in main, but included for completeness)
PrivateTmp=yes

# Protect kernel tunables
ProtectKernelTunables=yes

# Prevent loading kernel modules
ProtectKernelModules=yes

# Protect kernel logs from being read
ProtectKernelLogs=yes

# Prevent modifications to system clock
ProtectClock=yes

# Protect control groups from modification
ProtectControlGroups=yes

# Make /proc/[pid]/ invisible to other users
ProtectProc=invisible

# Deny access to /proc/sys - already covered by ProtectKernelTunables
ProcSubset=pid

# ============================================================================
# DEVICE ACCESS CONTROL
# ============================================================================

# Create private /dev with only necessary device nodes
PrivateDevices=yes

# Deny access to all devices by default
DevicePolicy=closed

# If specific devices are needed, add them here:
# DeviceAllow=/dev/null rw
# DeviceAllow=/dev/zero rw

# ============================================================================
# NAMESPACE ISOLATION
# ============================================================================

# Use private user namespace (isolates UIDs/GIDs)
# Note: May interfere with capability-based operations, test carefully
# PrivateUsers=yes

# Use private IPC namespace (separate System V IPC, POSIX message queues)
PrivateIPC=yes

# Prevent hostname changes
ProtectHostname=yes

# Restrict creation of namespaces
RestrictNamespaces=yes

# Prevent realtime scheduling
RestrictRealtime=yes

# ============================================================================
# MISCELLANEOUS HARDENING
# ============================================================================

# Prevent personality() syscall (prevents execution of non-native binaries)
LockPersonality=yes

# Remove setuid/setgid bits on exec
RestrictSUIDSGID=yes

# Remove IPC objects on service stop
RemoveIPC=yes

# Only allow native architecture syscalls
SystemCallArchitectures=native

# ============================================================================
# SYSTEM CALL FILTERING (Seccomp-BPF)
# ============================================================================

# Allow only syscalls typical for system services
SystemCallFilter=@system-service

# Explicitly deny dangerous syscall groups:
# @clock          - Modify system time
# @cpu-emulation  - CPU emulation (QEMU, etc.)
# @debug          - Debugging/tracing (ptrace, etc.)
# @module         - Kernel module loading
# @mount          - Filesystem mounting
# @obsolete       - Obsolete syscalls
# @privileged     - Privileged operations (iopl, etc.)
# @raw-io         - Raw I/O operations
# @reboot         - System reboot/shutdown
# @swap           - Swap management
SystemCallFilter=~@clock @cpu-emulation @debug @module @mount @obsolete @privileged @raw-io @reboot @swap

# Log attempts to use forbidden syscalls (for debugging)
SystemCallErrorNumber=EPERM

# ============================================================================
# MEMORY PROTECTION
# ============================================================================

# Prevent process from creating writable executable memory
# This prevents JIT compilation and some exploits
MemoryDenyWriteExecute=yes

# ============================================================================
# NETWORK ISOLATION
# ============================================================================

# Anna needs network access for:
# - Package mirror checking
# - System updates
# - Web requests for advice data
# So we cannot use PrivateNetwork=yes

# Restrict address families to IPv4, IPv6, and Unix sockets
RestrictAddressFamilies=AF_INET AF_INET6 AF_UNIX

# ============================================================================
# RUNTIME DIRECTORY & SOCKET
# ============================================================================

# Create runtime directory with restrictive permissions
# (Already in main service, but we tighten permissions)
RuntimeDirectory=anna
RuntimeDirectoryMode=0750

# Socket permissions (for Unix domain socket)
# Owner: root, Group: annactl, Mode: 0660 (owner + group only)
# Note: Socket permissions are set in code (rpc_server.rs:102)
# But we ensure the runtime directory is only accessible to root:annactl
# SocketMode=0660
# SocketUser=root
# SocketGroup=annactl

# ============================================================================
# RESOURCE LIMITS
# ============================================================================

# Limit CPU time (disable for now, as some operations may be CPU intensive)
# CPUQuota=80%

# Limit memory usage (disable for now, may need tuning based on workload)
# MemoryMax=512M
# MemoryHigh=384M

# Limit number of tasks (processes/threads)
TasksMax=256

# ============================================================================
# LOGGING
# ============================================================================

# Ensure all output goes to journal
StandardOutput=journal
StandardError=journal
SyslogIdentifier=annad
SyslogLevel=info

# ============================================================================
# NOTES FOR FUTURE HARDENING
# ============================================================================

# The following features are commented out because they require additional
# work in the application code or may break functionality:
#
# 1. User/Group: Requires creating 'anna' user and implementing proper
#    privilege dropping in code. Currently annad must run as root to:
#    - Bind to /run/anna/anna.sock
#    - Execute package manager commands (pacman)
#    - Run systemctl commands
#
# 2. AmbientCapabilities/CapabilityBoundingSet: Requires implementing
#    capability dropping in main.rs after binding socket and before
#    entering main loop.
#
# 3. PrivateUsers: May interfere with capability-based privilege separation.
#    Needs testing.
#
# 4. ReadOnlyPaths: We use ProtectSystem=strict instead, which is more
#    comprehensive.
#
# 5. InaccessiblePaths: Not needed with ProtectSystem=strict.
#
# See SECURITY_AUDIT.md Phase 2 for implementation roadmap.
