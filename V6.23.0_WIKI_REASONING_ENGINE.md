# v6.23.0: Wiki Reasoning Engine - Complete Vertical Slice

**Release Date:** 2025-11-24
**Theme:** Transform Arch Wiki into a first-class reasoning source

## üéØ Core Achievement

v6.23.0 delivers the **Wiki Reasoning Engine** - a complete, tested vertical slice that transforms the Arch Wiki from "just a URL you paste" into an active reasoning source. When users ask questions like "my wifi drops sometimes, what should I check?", Anna now:

1. **Identifies** the topic (Networking) and intent (Troubleshoot)
2. **Fetches** relevant Arch Wiki content
3. **Combines** with system telemetry and knowledge
4. **Produces** tailored advice with concrete steps, commands, and citations

## üöÄ What's New

### Wiki Reasoning Pipeline

**New Modules:**
- `wiki_reasoner.rs` - Core reasoning engine and data structures
- `wiki_topics.rs` - Pattern-based topic classification
- `wiki_llm.rs` - LLM integration for structured reasoning
- `wiki_client.rs` (annad) - HTTP fetching with 7-day caching

**Supported Topics (5 vertical slices):**
1. **Power Management** - TLP, battery optimization, thermal management
2. **Disk Space** - Cleanup, large file detection, maintenance
3. **Boot Performance** - Startup optimization, systemd analysis
4. **Networking** - WiFi troubleshooting, DNS, connectivity
5. **GPU Stack** - NVIDIA, AMD, Intel graphics drivers

### Integration Architecture

**TIER 0.4 Placement:**
- Positioned after CIL (0.25) and before Diagnostics (0.5)
- Confidence threshold: 0.6 for wiki topic matching
- Falls through gracefully if no match or LLM fails

**Query Flow:**
```
User: "my wifi drops sometimes"
  ‚Üí classify_wiki_topic() ‚Üí Networking/Troubleshoot (0.85 confidence)
  ‚Üí reason_with_wiki() ‚Üí LLM + telemetry + wiki content
  ‚Üí format_wiki_advice() ‚Üí Structured CLI output
```

### LLM Integration

**Ollama Configuration:**
- Endpoint: `http://127.0.0.1:11434/v1/chat/completions`
- Model: `llama3.2:3b`
- Temperature: 0.3 (for consistent JSON)
- Timeout: 60 seconds
- Structured JSON schema enforcement

**WikiAdvice Structure:**
```rust
pub struct WikiAdvice {
    pub summary: String,              // 2-5 line explanation
    pub steps: Vec<WikiStep>,         // Ordered steps with commands
    pub notes: Vec<String>,           // Helpful hints
    pub citations: Vec<WikiCitation>, // Arch Wiki sources
}
```

### CLI Output Format

```
[SUMMARY]
Your WiFi connection drops are likely due to power management
settings or driver configuration. Let's check both.

[STEPS]
1. Check power management settings
   Verify if WiFi adapter is being power-managed aggressively

   $ iw dev
   $ cat /sys/module/iwlwifi/parameters/power_save

   ‚ö†Ô∏è  Do not disable power management globally without checking impact

2. Review driver configuration
   Check for known issues with your wireless driver

   $ dmesg | grep wifi
   $ journalctl -u NetworkManager --since today

[NOTES]
‚Ä¢ NetworkManager handles WiFi power management by default
‚Ä¢ Consider updating firmware if using Intel wireless cards

[REFERENCES]
‚Ä¢ https://wiki.archlinux.org/title/Network_configuration - Troubleshooting
‚Ä¢ https://wiki.archlinux.org/title/NetworkManager
```

## üß™ Testing

### Comprehensive Test Coverage

**Classification Tests (11 tests):**
- All 5 topics covered with real questions
- Intent detection (Troubleshoot, Install, Configure, Explain)
- Confidence scoring validation
- Metadata completeness verification

**Formatter Tests (2 tests):**
- Full WikiAdvice rendering with all fields
- Minimal advice with optional fields omitted
- Proper emoji rendering (‚ö†Ô∏è for cautions)
- Section structure validation

**Test Results:**
```
‚úì wiki_topics::tests - 11/11 passed
‚úì unified_query_handler::tests::format_wiki_advice - 2/2 passed
‚úì Full build passes with zero errors
```

## üìä Design Decisions

### Why Pattern-Based Classification?

**Decision:** Use keyword/regex patterns instead of LLM for classification

**Rationale:**
- **Speed:** Instant classification vs LLM round-trip
- **Determinism:** Same question always routes to same topic
- **Cost:** Zero LLM tokens for routing
- **Reliability:** No LLM timeout or failure modes in routing

**Trade-off:** Less flexible than LLM, but extensible taxonomy handles this

### Why LLM for Reasoning?

**Decision:** Use LLM to synthesize wiki + telemetry + knowledge

**Rationale:**
- **Adaptation:** Tailors generic wiki content to user's specific system
- **Context:** Combines multiple sources (telemetry shows Hyprland, wiki has Wayland gotchas)
- **Natural language:** Produces conversational, step-by-step guidance
- **Practicality:** Filters wiki's comprehensive docs to actionable subset

**Trade-off:** Non-deterministic, requires Ollama running, but acceptable for this use case

### Why No New CLI Commands?

**Decision:** Surface via natural language only (`annactl "wifi drops"`)

**Rationale:**
- **Simplicity:** Users don't need to know about wiki reasoning
- **Discovery:** Works automatically when question matches topic
- **Consistency:** Aligns with Anna's conversational interface philosophy

### Why 7-Day Wiki Cache?

**Decision:** Cache wiki pages for 7 days in `~/.cache/anna/wiki/`

**Rationale:**
- **Performance:** Instant retrieval after first fetch
- **Offline:** Works without internet after initial fetch
- **Freshness:** Weekly refresh keeps content reasonably current
- **Disk usage:** Negligible (few KB per page)

## üõ†Ô∏è Implementation Details

### Topic Classification

**Confidence Scoring:**
- High confidence (0.85-0.9): Multiple keyword matches
- Medium confidence (0.75-0.85): Single keyword match
- Low confidence (0.6-0.75): Related terms only
- Below 0.6: Falls through to next tier

**Intent Detection:**
- **Troubleshoot:** Default for most questions
- **Install:** Triggered by "install", "setup" keywords
- **Configure:** Triggered by "configure", "setup" keywords
- **ExplainConcept:** (Future) For "what is..." questions

### Wiki Metadata

Each topic has metadata defining:
- **page_url:** Primary Arch Wiki page
- **key_sections:** Relevant sections to extract

Example:
```rust
WikiTopic::PowerManagement => WikiTopicMetadata {
    page_url: "https://wiki.archlinux.org/title/Power_management",
    key_sections: &["Troubleshooting", "Power management tools", "TLP"],
}
```

### System Context

Built from telemetry for LLM context:
```
Desktop/WM: Hyprland
CPU: AMD Ryzen 7 5800X (16 cores)
Memory: 32.0 GB total, 18.5 GB used
Disk: Root at 65%
```

## üîÑ Integration Points

### Unified Query Handler (TIER 0.4)

```rust
// After CIL (TIER 0.25), before Diagnostics (TIER 0.5)
if let Some(topic_match) = wiki_topics::classify_wiki_topic(user_text) {
    if topic_match.confidence >= 0.6 {
        match reason_with_wiki(user_text, telemetry, &knowledge, &cfg).await {
            Ok(advice) => {
                let formatted = format_wiki_advice(&advice);
                return Ok(UnifiedQueryResult::ConversationalAnswer {
                    answer: formatted,
                    confidence: AnswerConfidence::High,
                    sources: wiki_citations,
                });
            }
            Err(e) => /* fall through to next tier */
        }
    }
}
```

### Dependencies Added

**annad/Cargo.toml:**
```toml
scraper = "0.17"    # HTML parsing for wiki client
html2text = "0.6"   # HTML to text conversion
dirs = "5.0"        # Cache directory resolution
```

## üìù Non-Goals (Explicitly Scoped Out)

‚úó **No hardcoded Q&A tables** - Knowledge flows from generic classification
‚úó **No new CLI commands** - Natural language only
‚úó **No full wiki corpus** - Fetch on-demand, cache for performance
‚úó **No ExplainConcept intent yet** - Future enhancement
‚úó **No LocalLLM fallback** - Requires Ollama running

## üéì User Experience

### Before v6.23.0
```
$ annactl "my wifi keeps dropping"
[Falls through to generic LLM or "I don't understand"]
```

### After v6.23.0
```
$ annactl "my wifi keeps dropping"
[SUMMARY]
Your WiFi connection drops are likely due to power management...

[STEPS]
1. Check power management settings
   $ iw dev
   $ cat /sys/module/iwlwifi/parameters/power_save

[NOTES]
‚Ä¢ NetworkManager handles WiFi power management by default

[REFERENCES]
‚Ä¢ https://wiki.archlinux.org/title/Network_configuration
```

## üîÆ Future Enhancements

**More Topics (v6.24+):**
- Printing (CUPS, driver issues)
- Sound (PipeWire, ALSA, PulseAudio)
- Containers (Docker, Podman)
- Virtualization (KVM, QEMU, libvirt)
- Security (firewall, SSH hardening)

**Enhanced Classification:**
- Multi-topic questions ("wifi and battery drain")
- ExplainConcept intent for learning queries
- Cross-topic correlation (GPU affects power management)

**Improved Caching:**
- Section-level caching for faster retrieval
- Background refresh for popular topics
- Offline corpus for fully disconnected operation

## üèóÔ∏è Architecture Vision

The Wiki Reasoning Engine establishes the pattern for **domain-specific reasoning modules**:

1. **Classification layer** (fast, deterministic) routes to domain
2. **Fetch layer** retrieves relevant knowledge (wiki, docs, man pages)
3. **Reasoning layer** (LLM) synthesizes knowledge + telemetry
4. **Output layer** formats for CLI/TUI consumption

Future domains could follow this pattern:
- **Arch Docs Reasoner** (pacman, makepkg, AUR)
- **Man Page Reasoner** (systemctl, journalctl, etc.)
- **Forum Reasoner** (Arch forums, Reddit r/archlinux)

## üì¶ Files Changed

**New Files:**
- `crates/anna_common/src/wiki_reasoner.rs` - Core types and pipeline
- `crates/anna_common/src/wiki_topics.rs` - Classification logic
- `crates/anna_common/src/wiki_llm.rs` - LLM integration
- `crates/annad/src/wiki_client.rs` - HTTP fetching and caching
- `V6.23.0_WIKI_REASONING_ENGINE.md` - This document

**Modified Files:**
- `crates/anna_common/src/lib.rs` - Added 3 new module exports
- `crates/annad/src/main.rs` - Added wiki_client module
- `crates/annad/Cargo.toml` - Added scraper, html2text, dirs deps
- `crates/annactl/src/unified_query_handler.rs` - TIER 0.4 integration + format_wiki_advice()
- `Cargo.toml` - Version bump to 6.23.0

## ‚úÖ Verification Checklist

- [x] All 5 topics have comprehensive patterns
- [x] Topic classification has 11 passing tests
- [x] LLM integration with Ollama works
- [x] WikiAdvice formatter has 2 passing tests
- [x] Full build passes with zero errors
- [x] TIER 0.4 integration in unified query handler
- [x] No hardcoded Q&A tables in main path
- [x] No template responses in reason_with_wiki()
- [x] Wiki citations included in all responses
- [x] System context built from telemetry

## üéâ Milestone Significance

v6.23.0 represents a **fundamental shift** in how Anna provides guidance:

**Before:** Generic LLM responses with occasional wiki URLs
**After:** Structured, wiki-backed reasoning with actionable steps

This is the **first domain-specific reasoning module** - a pattern we'll replicate for other knowledge sources (man pages, forums, docs). The architecture is proven, tested, and ready to scale.

---

**Next:** v6.24.0 will expand to **3 more wiki topics** (Printing, Sound, Containers) and implement **ExplainConcept intent** for learning-oriented queries.
