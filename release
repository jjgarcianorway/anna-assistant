#!/bin/bash
# Simple release script - no parameters needed
# Reads version from Cargo.toml, message from .release-message

set -euo pipefail

# Setup SSH agent if needed
if [ -z "${SSH_AUTH_SOCK:-}" ]; then
    echo "→ Starting SSH agent..."
    eval "$(ssh-agent -s)" > /dev/null
    ssh-add ~/.ssh/id_ed25519
fi

# Get current version from Cargo.toml
VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
TAG="v${VERSION}"

echo "╭─────────────────────────────────────────╮"
echo "│  Release: ${TAG}                          "
echo "╰─────────────────────────────────────────╯"
echo ""

# Check if .release-message exists
if [ ! -f .release-message ]; then
    echo "✗ Error: .release-message not found"
    echo ""
    echo "Create .release-message with your commit message, then run again."
    exit 1
fi

# Show release message
echo "Release message:"
echo "----------------------------------------"
cat .release-message
echo "----------------------------------------"
echo ""

# Clean up any conflicting tags
echo "→ Cleaning up old tags..."
git tag -d "${TAG}" 2>/dev/null || true
git push origin ":refs/tags/${TAG}" 2>/dev/null || true
echo ""

# Read commit message from file
COMMIT_MSG=$(cat .release-message)

# Use release.sh with explicit version
./scripts/release.sh -v "${VERSION}" -m "${COMMIT_MSG}" -y

echo ""
echo "✓ Release ${TAG} complete!"
echo ""
echo "Monitor build: https://github.com/jjgarcianorway/anna-assistant/actions"
echo ""
